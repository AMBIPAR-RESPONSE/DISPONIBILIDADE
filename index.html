<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Disponibilidade da Frota</title>

  <!-- Fontes & Ícones -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL@1" rel="stylesheet" />

  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- Export helpers -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1320; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937;
      --brand:#22c55e; --brand-2:#3b82f6; --danger:#ef4444; --chip:#0f172a; --line:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}

    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,19,32,.9);backdrop-filter: blur(8px);border-bottom:1px solid var(--border);}
    .topbar .row{display:flex;align-items:center;gap:16px;min-height:64px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px rgba(34,197,94,.25)}
    .spacer{flex:1}
    .btn{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#fff;display:flex;align-items:center;gap:8px;cursor:pointer}
    .btn.primary{background:var(--brand);border:none;color:#052e16;font-weight:700}

    .filters{display:flex;flex-wrap:wrap;gap:10px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:14px;margin-top:14px}
    .input, select, button{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb}
    .input::placeholder{color:#64748b}
    button.primary{background:var(--brand);border:none;color:#052e16;font-weight:700}
    button.ghost{background:transparent;color:#9aa4b2}
    .row{display:flex;gap:12px;align-items:center}
    label{display:flex;flex-direction:column;gap:6px;color:#cbd5e1;font-size:12px}

    .kpis{display:grid;gap:14px;margin-top:16px}
    @media(min-width:900px){.kpis{grid-template-columns:repeat(3,1fr)}}
    .kpi{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .kpi .icon{width:44px;height:44px;border-radius:12px;display:grid;place-items:center}
    .kpi h3{margin:0;font-size:13px;color:var(--muted);font-weight:700;letter-spacing:.3px;text-transform:uppercase}
    .kpi .val{font-size:28px;font-weight:800;margin-top:4px}
    .i-green{background:rgba(34,197,94,.12);color:#34d399}
    .i-blue {background:rgba(59,130,246,.10);color:#60a5fa}
    .i-red  {background:rgba(239,68,68,.10);color:#f87171}

    .section{display:flex;align-items:center;justify-content:space-between;margin:24px 0 10px}
    .section h2{margin:0;font-size:18px}

    .hgroup{display:flex;flex-direction:column;gap:10px;margin:14px 0 24px}
    .hline{display:flex;align-items:center;gap:12px}
    .hlabel{font-weight:800;letter-spacing:.3px;font-size:16px;color:#cbd5e1;white-space:nowrap}
    .hdivider{height:4px;background:var(--line);border-radius:3px;flex:1}

    .hlist{display:flex;flex-wrap:wrap;gap:14px;align-items:stretch}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;min-width:260px;max-width:360px;flex:1 1 260px}
    .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .prefixo{font-weight:800;font-size:18px}
    .chip{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;background:var(--chip);border:1px solid var(--border)}
    .chip.sb{color:#34d399}.chip.ms{color:#60a5fa}.chip.mt{color:#f87171}
    .chip.hr{background:rgba(34,197,94,.12); color:#34d399}
    .muted{color:var(--muted);font-size:12px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:#cbd5e1;font-size:13px;margin-top:8px}

    #chart_div{height:360px}
    #pie_div{height:260px}
    #pareto_div{height:360px}
    .foot{margin:28px 0;color:#64748b;font-size:12px;text-align:center}

    .divider{margin:26px 0 8px;border-bottom:4px solid #1f2937;display:flex;align-items:center;gap:12px}
    .divider .label{font-weight:800;letter-spacing:.3px;font-size:18px;color:#cbd5e1}

    /* MultiSelect */
    .ms{position:relative;min-width:220px}
    .ms-btn{display:flex;align-items:center;justify-content:space-between;gap:10px;min-width:220px;height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb;cursor:pointer}
    .ms-panel{position:absolute;top:44px;left:0;background:var(--card);border:1px solid var(--border);border-radius:12px;min-width:280px;max-height:280px;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;z-index:50}
    .ms.open .ms-panel{display:block}
    .ms-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04)}
    .ms-row:last-child{border-bottom:0}
    .ms-row input{width:16px;height:16px}
    .ms-title{font-size:12px;color:#9aa4b2;padding:8px 12px 0}
    .ms-footer{display:flex;gap:8px;justify-content:flex-end;padding:10px}
    .ms-footer button{height:34px;padding:0 12px}

    #exportArea{background:var(--bg); padding:0 0 10px 0;}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap row">
      <div class="brand"><span class="dot"></span> Disponibilidade da Frota</div>
      <div class="spacer"></div>
      <div class="topRight">
        <span id="userEmail" class="muted" style="display:none"></span>
        <button id="btnLogout" class="btn" style="display:none"><span class="material-symbols-rounded">logout</span> Sair</button>
        <button id="btnDownload" class="btn"><span class="material-symbols-rounded">download</span> Baixar</button>
        <a class="muted" href="#" id="btnRefresh" title="Atualizar"><span class="material-symbols-rounded">refresh</span></a>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginBox" class="loginWrap" style="display:none">
    <h1>Acesso restrito</h1>
    <label>Email
      <input id="lgEmail" class="input" type="email" placeholder="voce@empresa.com">
    </label>
    <label>Senha
      <input id="lgPass" class="input" type="password" placeholder="••••••••">
    </label>
    <div class="loginRow">
      <button id="btnLogin" class="btn primary" style="width:160px"><span class="material-symbols-rounded">login</span>&nbsp;Entrar</button>
      <span id="lgErr" class="err"></span>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashWrap" style="display:none">
    <div class="wrap">
      <!-- Filtros globais -->
      <div class="filters">
        <div class="row" style="flex:1;flex-wrap:wrap">
          <label>Data <input class="input" type="date" id="fData"></label>
          <label>Status
            <select id="fStatus">
              <option value="">Todos</option>
              <option value="STAND BY">STAND BY</option>
              <option value="MISSÃO">MISSÃO</option>
              <option value="MNT">MNT</option>
            </select>
          </label>
          <label>Buscar <input class="input" id="fBusca" placeholder="Prefixo, CMTE, Mecânico..."></label>
        </div>
        <div class="row">
          <button class="btn" id="btnHoje"><span class="material-symbols-rounded">calendar_month</span>&nbsp;Hoje</button>
          <button class="btn primary" id="btnFiltrar"><span class="material-symbols-rounded">tune</span>&nbsp;Aplicar</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="kpis">
        <div class="kpi"><div class="icon i-green">✓</div><div><h3>Disponíveis</h3><div class="val" id="kDisp">—</div></div></div>
        <div class="kpi"><div class="icon i-blue">✈</div><div><h3>Em Missão</h3><div class="val" id="kMissao">—</div></div></div>
        <div class="kpi"><div class="icon i-red">🛠</div><div><h3>Em Manutenção</h3><div class="val" id="kMnt">—</div></div></div>
      </div>

      
      <!-- ====== BLOCO EXPORTÁVEL ====== -->
      <div id="exportArea">
        <!-- Programação -->
        <div class="section">
          <h2>Programação</h2>
          <div class="row">
            <label>Base
              <select id="progBase" style="min-width:180px">
                <option value="">Todas</option>
              </select>
            </label>
          </div>
        </div>

        <!-- FAIXA: STAND BY -->
        <div class="hgroup">
          <div class="hline">
            <span class="hlabel">STAND BY <span class="muted" id="cntSB">(0)</span></span>
            <span class="hdivider"></span>
          </div>
          <div class="hlist" id="sbList"></div>
        </div>

        <!-- FAIXA: EM MISSÃO -->
        <div class="hgroup">
          <div class="hline">
            <span class="hlabel">EM MISSÃO <span class="muted" id="cntMS">(0)</span></span>
            <span class="hdivider"></span>
          </div>
          <div class="hlist" id="msList"></div>
        </div>

        <!-- FAIXA: EM MANUTENÇÃO -->
        <div class="hgroup">
          <div class="hline">
            <span class="hlabel">EM MANUTENÇÃO <span class="muted" id="cntMNT">(0)</span></span>
            <span class="hdivider"></span>
          </div>
          <div class="hlist" id="mntList"></div>
        </div>

        <!-- Pizza -->
        <div class="section">
          <h2>Status do dia</h2>
          <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap">
            <div class="muted" id="pie_date_hint"></div>
            <div style="flex:1"></div>
            <label>Base
              <select id="pieBase" style="min-width:180px">
                <option value="">Todas</option>
              </select>
            </label>
          </div>
        </div>
        <div id="pie_div"></div>
      </div>

      <div class="divider"><span class="label">Indicadores de Disponibilidade</span></div>

      <!-- Gráfico barras -->
      <div class="section">
        <h2>Disponíveis x Indisponíveis</h2>
        <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap">
          <label>Base
            <select id="baseChart" style="min-width:180px">
              <option value="">Todas</option>
            </select>
          </label>
          <label>Aeronave
            <select id="prefChart" style="min-width:160px">
              <option value="">Todas</option>
            </select>
          </label>
          <div style="flex:1"></div>
          <label>Período
            <select id="rangeSel">
              <option value="15d">15 dias</option>
              <option value="30d" selected>30 dias</option>
              <option value="60d">60 dias</option>
              <option value="90d">90 dias</option>
              <option value="180d">180 dias</option>
              <option value="12m">12 meses</option>
            </select>
          </label>
        </div>
      </div>
      <div id="chart_div"></div>

      <!-- Pareto -->
      <div class="section">
        <h2>Pareto • Motivos de Manutenção</h2>
        <div class="row" style="gap:14px; align-items:center; flex-wrap:wrap">
          <label>Período
            <select id="paretoRangeSel">
              <option value="15d">15 dias</option>
              <option value="30d" selected>30 dias</option>
              <option value="60d">60 dias</option>
              <option value="90d">90 dias</option>
              <option value="180d">180 dias</option>
              <option value="12m">12 meses</option>
            </select>
          </label>

          <!-- MultiSelect Bases -->
          <div class="ms" id="msBases">
            <div class="ms-btn"><span>Todos as Bases</span><span class="material-symbols-rounded" style="font-size:18px">expand_more</span></div>
            <div class="ms-panel">
              <div class="ms-title">Bases</div>
              <div class="ms-row"><input type="checkbox" id="msBases_all"><label for="msBases_all">Selecionar todas</label></div>
              <div id="msBases_list"></div>
              <div class="ms-footer">
                <button class="btn" type="button" id="msBases_clear">Limpar</button>
                <button class="btn primary" type="button" id="msBases_apply">Aplicar</button>
              </div>
            </div>
          </div>

          <!-- MultiSelect Prefixos -->
          <div class="ms" id="msPrefixos">
            <div class="ms-btn"><span>Todas as Aeronaves</span><span class="material-symbols-rounded" style="font-size:18px">expand_more</span></div>
            <div class="ms-panel">
              <div class="ms-title">Aeronaves</div>
              <div class="ms-row"><input type="checkbox" id="msPrefixos_all"><label for="msPrefixos_all">Selecionar todas</label></div>
              <div id="msPrefixos_list"></div>
              <div class="ms-footer">
                <button class="btn" type="button" id="msPrefixos_clear">Limpar</button>
                <button class="btn primary" type="button" id="msPrefixos_apply">Aplicar</button>
              </div>
            </div>
          </div>

        </div>
      </div>
      <div id="pareto_div"></div>

      <div class="foot">Atualiza a partir da sua planilha (Apps Script como API) • Visual restrito</div>
    </div>
  </div>

  <script>
    // ======= CONFIGURAÇÃO =======
    const API_URL = 'https://script.google.com/macros/s/AKfycbzqHQjxZykAeIE0uMXSqtt4wgrjbBiDqzgG3Knc1vAxEJaF4NZ11owSvuJaPjj2Cdva/exec';
    // ============================

    google.charts.load('current', {'packages':['corechart']});
    const $ = s => document.querySelector(s);
    const debounce = (fn,ms=350)=>{ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);}};
    const TOK_KEY='dash_t';
    function getToken(){ return localStorage.getItem(TOK_KEY)||''; }
    function setToken(t){ if(t) localStorage.setItem(TOK_KEY,t); else localStorage.removeItem(TOK_KEY); }

    let HORAS_MAP = {};                         // ex.: { "PP-CBM": 20.5, "PS-PIP": 77.5 }
    const getHoras = (pref) => Number(HORAS_MAP[String(pref||'').trim()] || 0);
              
    // fetch com proteção contra HTML de erro da implantação
    async function apiFetch(params){
      const qp = new URLSearchParams(params);
      const t = getToken();
      if (t) qp.set('t', t);

      const url = API_URL + '?' + qp.toString();
      let text;
      try{
        const res = await fetch(url, { cache: 'no-store' });
        text = await res.text();
      }catch(e){
        throw new Error('Falha de rede ao acessar a API: ' + e.message);
      }

      let json;
      try{
        json = JSON.parse(text);
      }catch(e){
        throw new Error('A API não retornou JSON. Verifique a URL/implantação. Resposta: ' + text.slice(0,200));
      }

      if (json && json.error === 'UNAUTHORIZED'){
        setToken(''); showLogin(); throw new Error('UNAUTHORIZED');
      }
      return json;
    }

    async function checkMe(){
      const t=getToken(); if(!t) return false;
      const r = await apiFetch({fn:'me'}).catch(()=>null);
      if (r && r.ok && r.data && r.data.ok){
        const email = r.data.email || '';
        $('#userEmail').textContent=email;
        $('#userEmail').style.display='inline';
        $('#btnLogout').style.display='inline-flex';
        return true;
      }
      return false;
    }
    async function login(){
      const email=$('#lgEmail').value.trim();
      const password=$('#lgPass').value;
      $('#lgErr').textContent='';
      try{
        const r = await apiFetch({fn:'login', email, password});
        const data = r.data || {};
        if (!data.ok){ $('#lgErr').textContent = data.error || 'Falha no login'; return; }
        setToken(data.token); $('#lgPass').value=''; showDash(); await refreshAll();
      }catch(err){ $('#lgErr').textContent = 'Erro ao autenticar'; }
    }
    async function logout(){
      const t=getToken(); if(t){ await apiFetch({fn:'logout'}).catch(()=>{}); }
      setToken(''); $('#userEmail').style.display='none'; $('#btnLogout').style.display='none'; showLogin();
    }
    function showLogin(){ $('#loginBox').style.display='block'; $('#dashWrap').style.display='none'; }
    function showDash(){ $('#loginBox').style.display='none'; $('#dashWrap').style.display='block'; }

    /* ===== MultiSelect ===== */
    function createMultiSelect(rootId, placeholder){
      const root = document.getElementById(rootId);
      const btn  = root.querySelector('.ms-btn');
      const panel= root.querySelector('.ms-panel');
      const all  = root.querySelector(`#${rootId}_all`);
      const list = root.querySelector(`#${rootId}_list`);
      const apply= root.querySelector(`#${rootId}_apply`);
      const clear= root.querySelector(`#${rootId}_clear`);
      let items = []; let selected = new Set();
      const updateBtn = ()=>{ if(selected.size===0) btn.querySelector('span').textContent=placeholder;
        else if (selected.size===items.length) btn.querySelector('span').textContent='Todos';
        else if (selected.size===1) btn.querySelector('span').textContent=[...selected][0];
        else btn.querySelector('span').textContent=`${selected.size} selecionadas`; };
      const render = ()=>{ list.innerHTML = items.map(v=>`<div class="ms-row"><input type="checkbox" id="${rootId}_${v}" value="${v}" ${selected.has(v)?'checked':''}><label for="${rootId}_${v}">${v}</label></div>`).join(''); all.checked = selected.size===items.length && items.length>0; updateBtn(); };
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); root.classList.toggle('open'); });
      document.addEventListener('click', ()=> root.classList.remove('open')); panel.addEventListener('click', (e)=> e.stopPropagation());
      all.addEventListener('change', ()=>{ selected = all.checked ? new Set(items) : new Set(); render(); });
      list.addEventListener('change', (e)=>{ if (e.target && e.target.type==='checkbox'){ const v=e.target.value; if (e.target.checked) selected.add(v); else selected.delete(v); all.checked = selected.size===items.length; updateBtn(); }});
      clear.addEventListener('click', ()=>{ selected.clear(); all.checked=false; render(); });
      apply.addEventListener('click', ()=>{ root.classList.remove('open'); refreshPareto(); });
      return { setItems(arr){ items=[...arr]; selected.clear(); render(); }, values(){ return [...selected]; }, setSelected(arr){ const set = new Set(arr||[]); selected = new Set(items.filter(v => set.has(v))); render(); } };
    }
    const msBases    = createMultiSelect('msBases','Todas as Bases');
    const msPrefixos = createMultiSelect('msPrefixos','Todas as Aeronaves');

    function chip(status){
      const S = String(status||'').toUpperCase();
      if (S==='STAND BY') return '<span class="chip sb">STAND BY</span>';
      if (S==='MISSÃO' || S==='MISSAO') return '<span class="chip ms">MISSÃO</span>';
      if (S==='MNT') return '<span class="chip mt">MNT</span>';
      return `<span class="chip">${status||'-'}</span>`;
    }

   function renderListaGrouped(rows){
  const baseSel = $('#progBase').value || '';
  const norm = s => String(s||'').toLowerCase();
  const SB=[], MS=[], MNT=[];
  for(const r of rows){
    if (baseSel && norm(r.Base)!==norm(baseSel)) continue;
    const st = String(r.Status||'').toUpperCase();

    const horas = getHoras(r.Prefixo); // horas do mês deste prefixo
    const horasChip = horas > 0
      ? `<span class="chip hr">${horas.toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})} h</span>`
      : '';

    const card = `
      <div class="card">
        <div class="title">
          <div class="prefixo">${r.Prefixo||'-'}</div>
          <div style="display:flex;gap:8px;align-items:center">
            ${horasChip}
            ${chip(r.Status)}
          </div>
        </div>
        <div class="muted">${r.Base||'-'} • ${r.Data||'-'}</div>
        <div class="meta">
          <div><b>Missão:</b> ${r.Missao||'-'}</div>
          <div><b>CMTE:</b> ${r.Comandante||'-'}</div>
          <div><b>MEC:</b> ${r.Mecanico||'-'}</div>
          ${r.Motivo_Manutencao ? `<div><b>Manutenção:</b> ${r.Motivo_Manutencao}</div>` : ``}
          ${r.Previsao ? `<div><b>Previsão:</b> ${r.Previsao}</div>` : ``}
        </div>
        ${r.Observacoes ? `<div class="muted" style="margin-top:8px">${r.Observacoes}</div>` : ``}
      </div>`;
    if (st==='STAND BY') SB.push(card); else if (st==='MNT') MNT.push(card); else MS.push(card);
  }
  $('#sbList').innerHTML  = SB.length ? SB.join('')  : `<div class="muted">—</div>`;
  $('#msList').innerHTML  = MS.length ? MS.join('')  : `<div class="muted">—</div>`;
  $('#mntList').innerHTML = MNT.length? MNT.join('') : `<div class="muted">—</div>`;
  $('#cntSB').textContent  = `(${SB.length})`;
  $('#cntMS').textContent  = `(${MS.length})`;
  $('#cntMNT').textContent = `(${MNT.length})`;
}

    /* Charts */
    function drawColumns(rows, isMonthly){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string', isMonthly ? 'Mês' : 'Data');
      dt.addColumn('number','Disponível');
      dt.addColumn('number','Indisponível');
      (isMonthly ? rows.map(r=>[String(r.Mes), +r['Disponível']||0, +r['Indisponível']||0])
                 : rows.map(r=>[String(r.Data), +r['Disponível']||0, +r['Indisponível']||0])
      ).forEach(r=>dt.addRow(r));
      const options = {
        legend:{ position:'bottom', textStyle:{ color:'#cbd5e1' } },
        backgroundColor:'transparent',
        hAxis:{ textStyle:{ color:'#94a3b8' } },
        vAxis:{ textStyle:{ color:'#94a3b8' }, gridlines:{ color:'#1f2937' } },
        chartArea:{ left:40, top:10, right:10, height:260 },
        height:360,
        isStacked:false,
        series:{ 0:{ color:'#22c55e' }, 1:{ color:'#ef4444' } }
      };
      new google.visualization.ColumnChart($('#chart_div')).draw(dt, options);
    }
    function drawPie(rows, date){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string','Status'); dt.addColumn('number','Qtde');
      rows.forEach(r=> dt.addRow([r.Status, Number(r.Qtde||0)]));
      $('#pie_date_hint').textContent = 'Dia: '+date;
      const options = {
        pieHole:0.55, legend:{position:'bottom', textStyle:{color:'#cbd5e1'}},
        backgroundColor:'transparent',
        chartArea:{ left:10, top:10, right:10, height:180 },
        slices:{ 0:{color:'#22c55e'}, 1:{color:'#3b82f6'}, 2:{color:'#ef4444'} }
      };
      new google.visualization.PieChart($('#pie_div')).draw(dt, options);
    }
    function drawPareto(rows){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string','Motivo'); dt.addColumn('number','Qtde'); dt.addColumn({type:'string', role:'annotation'});
      rows.forEach(r=> dt.addRow([r.Motivo, Number(r.Qtde||0), String(r.Qtde||0)]));
      const options = {
        backgroundColor:'transparent', legend:'none',
        annotations:{ textStyle:{ color:'#e5e7eb', bold:true }},
        hAxis:{ textStyle:{ color:'#94a3b8' }, gridlines:{ color:'#1f2937' }, minValue:0 },
        vAxis:{ textStyle:{ color:'#94a3b8' } },
        colors:['#ef4444'], chartArea:{ left:120, top:10, right:20, height:260 }, height:360
      };
      new google.visualization.BarChart($('#pareto_div')).draw(dt, options);
    }

  
      wrap.innerHTML = data.rows.map(r => `
        <div class="card">
          <div class="title">
            <div class="prefixo">${r.Aeronave}</div>
            <span class="chip sb">${Number(r.Horas||0).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})} h</span>
          </div>
        </div>
      `).join('');
    }
async function refreshAll(){
  const date    = $('#fData').value || '';
  const status  = $('#fStatus').value || '';
  const search  = $('#fBusca').value || '';
  const range   = $('#rangeSel').value || '30d';
  const base    = $('#baseChart').value || '';
  const prefixo = $('#prefChart').value || '';

  const progBaseVal = $('#progBase').value || '';
  const pieBaseSel  = $('#pieBase').value || '';
  const pieBase     = progBaseVal !== '' ? progBaseVal : pieBaseSel;

  const paretoBasesCSV    = msBases.values().join(',');
  const paretoPrefixosCSV = msPrefixos.values().join(',');

  // 1) HORAS DO MÊS → preencher mapa para usar nos cards da programação
  HORAS_MAP = {};
  try{
    const h = await apiFetch({ fn:'horas', date }); // seu endpoint já retorna Aeronave/Horas do mês
    if (h && h.ok && h.data && Array.isArray(h.data.rows)){
      h.data.rows.forEach(r => {
        HORAS_MAP[String(r.Aeronave||'').trim()] = Number(r.Horas||0);
      });
    }
  }catch(e){ /* deixa sem horas se falhar */ }

  // 2) RESTO DO DASH
  const qs = { fn:'dashboard', date, status, search, range, base, prefixos: prefixo, pieBase,
               paretoBases: paretoBasesCSV, paretoPrefixos: paretoPrefixosCSV };
  const res = await apiFetch(qs);
  const data = res.data;

  if ($('#baseChart').options.length<=1){
    const basesOpt   = '<option value="">Todas</option>' + data.lookups.bases.map(v=>`<option>${v}</option>`).join('');
    const prefOpt    = '<option value="">Todas</option>' + data.lookups.prefixos.map(v=>`<option>${v}</option>`).join('');
    $('#baseChart').innerHTML = basesOpt;
    $('#pieBase').innerHTML   = basesOpt;
    $('#progBase').innerHTML  = basesOpt;
    $('#prefChart').innerHTML = prefOpt;

    msBases.setItems(data.lookups.bases);
    msPrefixos.setItems(data.lookups.prefixos);
  }

  renderListaGrouped(data.list);
  $('#kDisp').textContent    = data.kpis.disponiveis ?? '0';
  $('#kMissao').textContent  = data.kpis.missao ?? '0';
  $('#kMnt').textContent     = data.kpis.manutencao ?? '0';

  google.charts.setOnLoadCallback(()=> {
    drawPie(data.pie, date);
    drawColumns(data.series, range==='12m');
    drawPareto(data.pareto);
  });
}

   

      renderListaGrouped(data.list);
      $('#kDisp').textContent    = data.kpis.disponiveis ?? '0';
      $('#kMissao').textContent  = data.kpis.missao ?? '0';
      $('#kMnt').textContent     = data.kpis.manutencao ?? '0';

      google.charts.setOnLoadCallback(()=> {
        drawPie(data.pie, date);
        drawColumns(data.series, range==='12m');
        drawPareto(data.pareto);
      });
    }
    const refreshPareto = debounce(refreshAll, 150);

    /* Eventos */
    $('#btnFiltrar').addEventListener('click', refreshAll);
    $('#btnHoje').addEventListener('click', ()=>{ $('#fData').value = new Date().toISOString().slice(0,10); refreshAll(); });
    $('#btnRefresh').addEventListener('click', refreshAll);
    $('#btnLogout').addEventListener('click', logout);
    $('#btnLogin').addEventListener('click', login);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && $('#loginBox').style.display!=='none') login(); });

    $('#baseChart').addEventListener('change', ()=>{ refreshAll(); });
    $('#prefChart').addEventListener('change', ()=>{ refreshAll(); });
    $('#rangeSel').addEventListener('change', refreshAll);
    $('#pieBase').addEventListener('change', refreshAll);
    $('#progBase').addEventListener('change', ()=>{ $('#pieBase').value = $('#progBase').value || ''; refreshAll(); });

    $('#paretoRangeSel').addEventListener('change', refreshPareto);
    $('#fBusca').addEventListener('input', debounce(refreshAll, 400));
    $('#fStatus').addEventListener('change', refreshAll);

    (async function init(){
      // começa mostrando o login; se token válido, troca para dash
      showLogin();
      try{
        const ok = await checkMe();
        if (ok){ showDash(); await refreshAll(); }
      }catch(e){
        console.error(e);
        const el = document.getElementById('lgErr');
        if (el) el.textContent = 'Erro ao conectar à API. Confira a URL e a implantação.';
      }
    })();

    /* ====== Baixar PDF ====== */
    async function downloadPDF(){
      const node = document.getElementById('exportArea');
      await new Promise(r=>requestAnimationFrame(r));
      const scale = Math.max(2, (window.devicePixelRatio || 1)) * 1.25;
      const canvas = await html2canvas(node, {
        backgroundColor: getComputedStyle(document.body).backgroundColor || '#0b1320',
        scale, useCORS: true, windowWidth: document.documentElement.clientWidth
      });
      const imgData = canvas.toDataURL('image/png');
      const w = canvas.width, h = canvas.height;
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: w>=h?'landscape':'portrait', unit:'pt', format:[w,h] });
      pdf.addImage(imgData, 'PNG', 0, 0, w, h, undefined, 'FAST');
      pdf.save(`Dashboard_Frota_${new Date().toISOString().slice(0,10)}.pdf`);
    }
    document.getElementById('btnDownload').addEventListener('click', downloadPDF);
  </script>
</body>
</html>
