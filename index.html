<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Disponibilidade da Frota</title>

  <!-- Fontes & Ícones -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL@1" rel="stylesheet" />

  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- Export helpers -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1320; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937;
      --brand:#22c55e; --brand-2:#3b82f6; --danger:#ef4444; --chip:#0f172a; --line:#1f2937;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}

    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,19,32,.9);backdrop-filter: blur(8px);border-bottom:1px solid var(--border);}
    .topbar .row{display:flex;align-items:center;gap:16px;min-height:64px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px rgba(34,197,94,.25)}
    .spacer{flex:1}
    .btn{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#fff;display:flex;align-items:center;gap:8px;cursor:pointer}
    .btn.primary{background:var(--brand);border:none;color:#052e16;font-weight:700}
    .btn.ghost{background:transparent;color:#9aa4b2}

    .filters{display:flex;flex-wrap:wrap;gap:10px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:14px;margin-top:14px}
    .input, select, button{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb}
    .input::placeholder{color:#64748b}
    .row{display:flex;gap:12px;align-items:center}
    label{display:flex;flex-direction:column;gap:6px;color:#cbd5e1;font-size:12px}

    .kpis{display:grid;gap:14px;margin-top:16px}
    @media(min-width:900px){.kpis{grid-template-columns:repeat(3,1fr)}}
    .kpi{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .kpi .icon{width:44px;height:44px;border-radius:12px;display:grid;place-items:center}
    .kpi h3{margin:0;font-size:13px;color:var(--muted);font-weight:700;letter-spacing:.3px;text-transform:uppercase}
    .kpi .val{font-size:28px;font-weight:800;margin-top:4px}
    .i-green{background:rgba(34,197,94,.12);color:#34d399}
    .i-blue {background:rgba(59,130,246,.10);color:#60a5fa}
    .i-red  {background:rgba(239,68,68,.10);color:#f87171}

    .section{display:flex;align-items:center;justify-content:space-between;margin:24px 0 10px}
    .section h2{margin:0;font-size:18px}

    .hgroup{display:flex;flex-direction:column;gap:10px;margin:14px 0 24px}
    .hline{display:flex;align-items:center;gap:12px}
    .hlabel{font-weight:800;letter-spacing:.3px;font-size:16px;color:#cbd5e1;white-space:nowrap}
    .hdivider{height:4px;background:var(--line);border-radius:3px;flex:1}

    .hlist{display:flex;flex-wrap:wrap;gap:14px;align-items:stretch}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;min-width:260px;max-width:360px;flex:1 1 260px;transition:transform .12s}
    .card:hover{transform:translateY(-4px)}
    .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .prefixo{font-weight:800;font-size:18px}
    .chip{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;background:var(--chip);border:1px solid var(--border)}
    .chip.sb{color:#34d399}.chip.ms{color:#60a5fa}.chip.mt{color:#f87171}
    .chip.hr{background:rgba(34,197,94,.12); color:#34d399}
    .muted{color:var(--muted);font-size:12px}
    .meta{display:flex;flex-direction:column;gap:6px;color:#cbd5e1;font-size:13px;margin-top:8px}

    #chart_div{height:360px}
    #pie_div{height:260px}
    #pareto_div{height:360px}
    .foot{margin:28px 0;color:#64748b;font-size:12px;text-align:center}

    .divider{margin:26px 0 8px;border-bottom:4px solid #1f2937;display:flex;align-items:center;gap:12px}
    .divider .label{font-weight:800;letter-spacing:.3px;font-size:18px;color:#cbd5e1}

    /* MultiSelect */
    .ms{position:relative;min-width:220px}
    .ms-btn{display:flex;align-items:center;justify-content:space-between;gap:10px;min-width:220px;height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb;cursor:pointer}
    .ms-panel{position:absolute;top:44px;left:0;background:var(--card);border:1px solid var(--border);border-radius:12px;min-width:280px;max-height:280px;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;z-index:50}
    .ms.open .ms-panel{display:block}
    .ms-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04)}
    .ms-row:last-child{border-bottom:0}
    .ms-row input{width:16px;height:16px}
    .ms-title{font-size:12px;color:#9aa4b2;padding:8px 12px 0}
    .ms-footer{display:flex;gap:8px;justify-content:flex-end;padding:10px}
    .ms-footer button{height:34px;padding:0 12px}

    #exportArea{
      background:var(--bg);
      padding:32px 36px 36px;   /* respiro interno pro PDF e pra tela */
      border-radius:16px;       /* opcional: dá um acabamento melhor no recorte */
    }

    /* Indica que o prefixo é clicável */
    .prefixo[data-prefixo]{ cursor:pointer; text-decoration:none; }
    .prefixo[data-prefixo]:hover{ text-decoration:underline; }

    /* Modal simples - empilhado (vertical) */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:2000; }
    .modal{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:18px; width:520px; max-width:95%; color:var(--text); box-shadow:0 20px 50px rgba(0,0,0,.6)}
    .modal h3{ margin:0 0 8px 0; font-size:16px }
    .modal .row{ margin:8px 0; display:flex; gap:8px; flex-direction:column; align-items:stretch }
    .modal label{ width:100%; display:flex; flex-direction:column; gap:6px; color:#cbd5e1; font-size:13px }
    .modal select.input, .modal input.input { width:100%; box-sizing:border-box; }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
    .small{ font-size:13px; color:var(--muted) }

    .btnLoading{ opacity:.7; pointer-events:none }

    /* Pareto slice colors hint */
    .legend-swatch{ display:inline-block; width:12px; height:12px; margin-right:6px; vertical-align:middle; border-radius:3px }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap row">
      <div class="brand"><span class="dot"></span> Disponibilidade da Frota</div>
      <div class="spacer"></div>
      <div class="topRight">
        <span id="userEmail" class="muted" style="display:none"></span>
        <button id="btnLogout" class="btn" style="display:none"><span class="material-symbols-rounded">logout</span> Sair</button>
        <button id="btnDownload" class="btn"><span class="material-symbols-rounded">download</span> Baixar</button>
        <a class="muted" href="#" id="btnRefresh" title="Atualizar"><span class="material-symbols-rounded">refresh</span></a>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginBox" class="loginWrap" style="display:none; padding:20px; max-width:420px; margin:20px auto; background:var(--card); border-radius:12px;">
    <h1 style="margin:0 0 12px">Acesso restrito</h1>
    <label>Email
      <input id="lgEmail" class="input" type="email" placeholder="voce@empresa.com">
    </label>
    <label>Senha
      <input id="lgPass" class="input" type="password" placeholder="••••••••">
    </label>
    <div class="loginRow" style="margin-top:10px; display:flex; gap:8px; align-items:center">
      <button id="btnLogin" class="btn primary" style="width:160px"><span class="material-symbols-rounded">login</span>&nbsp;Entrar</button>
      <span id="lgErr" class="err" style="color:var(--danger)"></span>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashWrap" style="display:none">
    <div class="wrap">
      <!-- Filtros globais -->
      <div class="filters">
        <div class="row" style="flex:1;flex-wrap:wrap">
          <label>Data <input class="input" type="date" id="fData"></label>
          <label>Status
            <select id="fStatus">
              <option value="">Todos</option>
              <option value="STAND BY">Disponível</option>
              <option value="MNT">Indisponível</option>
            </select>
          </label>
          <label>Buscar <input class="input" id="fBusca" placeholder="Prefixo, CMTE, Mecânico..."></label>
        </div>
        <div class="row">
          <button class="btn" id="btnHoje"><span class="material-symbols-rounded">calendar_month</span>&nbsp;Hoje</button>
          <button class="btn primary" id="btnFiltrar"><span class="material-symbols-rounded">tune</span>&nbsp;Aplicar</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="kpis">
        <div class="kpi">
          <div class="icon i-green">✓</div>
          <div><h3>Disponíveis</h3><div class="val" id="kDisp">—</div></div>
        </div>

        <div class="kpi">
          <div class="icon i-red">⛔</div>
          <div><h3>Indisponíveis</h3><div class="val" id="kInd">—</div></div>
        </div>

        <div class="kpi">
          <div class="icon i-blue">⏱</div>
          <div><h3>Horas no mês</h3><div class="val" id="kHoras">—</div></div>
        </div>
      </div>

      <!-- ====== BLOCO EXPORTÁVEL ====== -->
      <div id="exportArea">

      <!-- Programação -->
      <div class="section">
        <h2>Programação</h2>
        <div class="row">
          <label>Base
            <select id="progBase" style="min-width:180px">
              <option value="">Todas</option>
            </select>
          </label>
        </div>
      </div>

      <!-- FAIXA: DISPONÍVEL -->
      <div class="hgroup">
        <div class="hline">
          <span class="hlabel">DISPONÍVEL <span class="muted" id="cntDISP">(0)</span></span>
          <span class="hdivider"></span>
        </div>
        <div class="hlist" id="dispList"></div>
      </div>

      <!-- FAIXA: INDISPONÍVEL -->
      <div class="hgroup">
        <div class="hline">
          <span class="hlabel">INDISPONÍVEL <span class="muted" id="cntIND">(0)</span></span>
          <span class="hdivider"></span>
        </div>
        <div class="hlist" id="indList"></div>
      </div>

      <!-- Pizza -->
      <div class="section">
        <h2>Status do dia</h2>
        <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap">
          <div class="muted" id="pie_date_hint"></div>
          <div style="flex:1"></div>
          <label>Base
            <select id="pieBase" style="min-width:180px">
              <option value="">Todas</option>
            </select>
          </label>
        </div>
      </div>
      <div id="pie_div"></div>
      </div>

      <div class="divider"><span class="label">Indicadores de Disponibilidade</span></div>

      <!-- Gráfico barras -->
      <div class="section">
        <h2>Disponíveis x Indisponíveis</h2>
        <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap">
          <label>Base
            <select id="baseChart" style="min-width:180px">
              <option value="">Todas</option>
            </select>
          </label>
          <label>Aeronave
            <select id="prefChart" style="min-width:160px">
              <option value="">Todas</option>
            </select>
          </label>
          <div style="flex:1"></div>
          <label>Período
            <select id="rangeSel">
              <option value="15d">15 dias</option>
              <option value="30d" selected>30 dias</option>
              <option value="60d">60 dias</option>
              <option value="90d">90 dias</option>
              <option value="180d">180 dias</option>
              <option value="12m">12 meses</option>
            </select>
          </label>
        </div>
      </div>
      <div id="chart_div"></div>

      <!-- Pareto -->
      <div class="section">
        <h2>Pareto • Motivos de Manutenção</h2>
        <div class="row" style="gap:14px; align-items:center; flex-wrap:wrap">
          <label>Período
            <select id="paretoRangeSel">
              <option value="15d">15 dias</option>
              <option value="30d" selected>30 dias</option>
              <option value="60d">60 dias</option>
              <option value="90d">90 dias</option>
              <option value="180d">180 dias</option>
              <option value="12m">12 meses</option>
            </select>
          </label>

          <!-- MultiSelect Bases -->
          <div class="ms" id="msBases">
            <div class="ms-btn"><span>Todos as Bases</span><span class="material-symbols-rounded" style="font-size:18px">expand_more</span></div>
            <div class="ms-panel">
              <div class="ms-title">Bases</div>
              <div class="ms-row"><input type="checkbox" id="msBases_all"><label for="msBases_all">Selecionar todas</label></div>
              <div id="msBases_list"></div>
              <div class="ms-footer">
                <button class="btn" type="button" id="msBases_clear">Limpar</button>
                <button class="btn primary" type="button" id="msBases_apply">Aplicar</button>
              </div>
            </div>
          </div>

          <!-- MultiSelect Prefixos -->
          <div class="ms" id="msPrefixos">
            <div class="ms-btn"><span>Todas as Aeronaves</span><span class="material-symbols-rounded" style="font-size:18px">expand_more</span></div>
            <div class="ms-panel">
              <div class="ms-title">Aeronaves</div>
              <div class="ms-row"><input type="checkbox" id="msPrefixos_all"><label for="msPrefixos_all">Selecionar todas</label></div>
              <div id="msPrefixos_list"></div>
              <div class="ms-footer">
                <button class="btn" type="button" id="msPrefixos_clear">Limpar</button>
                <button class="btn primary" type="button" id="msPrefixos_apply">Aplicar</button>
              </div>
            </div>
          </div>

        </div>
      </div>
      <div id="pareto_div"></div>

      <div class="foot">Atualiza a partir da sua planilha (Apps Script como API) • Visual restrito</div>
    </div>
  </div>

  <!-- Modal holder: criado dinamicamente -->
  <div id="editModal" style="display:none"></div>

  <script>
    // ======= CONFIGURAÇÃO =======
    const API_URL = 'https://script.google.com/macros/s/AKfycbwGNWh1CxWxT_yA9E23V4j6ossYmOA1Tt2gn58Xp8DhY3vOGMGJjtiWuLZUn6gqiAY/exec';
    // ============================

    google.charts.load('current', {'packages':['corechart']});
    const $ = s => document.querySelector(s);
    const debounce = (fn,ms=350)=>{ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);}};
    const TOK_KEY='dash_t';
    function getToken(){ return localStorage.getItem(TOK_KEY)||''; }
    function setToken(t){ if(t) localStorage.setItem(TOK_KEY,t); else localStorage.removeItem(TOK_KEY); }

    // Horas do mês por aeronave (preenchido em refreshAll)
    let HORAS_MAP = {};
    const getHoras = (pref) => Number(HORAS_MAP[String(pref||'').trim()] || 0);

    // Últimos lookups recebidos (bases, prefixos, missoes, comandantes, copilotos, mecanicos)
    let LOOKUPS = { bases:[], prefixos:[], missoes:[], comandantes:[], copilotos:[], mecanicos:[] };

    // fetch com proteção contra HTML de erro da implantação
    async function apiFetch(params){
      const qp = new URLSearchParams(params);
      const t = getToken();
      if (t) qp.set('t', t);

      const url = API_URL + '?' + qp.toString();
      let text;
      try{
        const res = await fetch(url, { cache: 'no-store' });
        text = await res.text();
      }catch(e){
        throw new Error('Falha de rede ao acessar a API: ' + e.message);
      }

      let json;
      try{
        json = JSON.parse(text);
      }catch(e){
        throw new Error('A API não retornou JSON. Verifique a URL/implantação. Resposta: ' + text.slice(0,200));
      }

      if (json && json.error === 'UNAUTHORIZED'){
        setToken(''); showLogin(); throw new Error('UNAUTHORIZED');
      }
      return json;
    }

    async function checkMe(){
      const t=getToken(); if(!t) return false;
      const r = await apiFetch({fn:'me'}).catch(()=>null);
      if (r && r.ok && r.data && r.data.ok){
        const email = r.data.email || '';
        $('#userEmail').textContent=email;
        $('#userEmail').style.display='inline';
        $('#btnLogout').style.display='inline-flex';
        return true;
      }
      return false;
    }
    async function login(){
      const email=$('#lgEmail').value.trim();
      const password=$('#lgPass').value;
      $('#lgErr').textContent='';
      try{
        const r = await apiFetch({fn:'login', email, password});
        const data = r.data || {};
        if (!data.ok){ $('#lgErr').textContent = data.error || 'Falha no login'; return; }
        setToken(data.token); $('#lgPass').value=''; showDash(); await refreshAll();
      }catch(err){ $('#lgErr').textContent = 'Erro ao autenticar'; }
    }
    async function logout(){
      const t=getToken(); if(t){ await apiFetch({fn:'logout'}).catch(()=>{}); }
      setToken(''); $('#userEmail').style.display='none'; $('#btnLogout').style.display='none'; showLogin();
    }
    function showLogin(){ $('#loginBox').style.display='block'; $('#dashWrap').style.display='none'; }
    function showDash(){ $('#loginBox').style.display='none'; $('#dashWrap').style.display='block'; }

    /* ===== MultiSelect ===== */
    function createMultiSelect(rootId, placeholder){
      const root = document.getElementById(rootId);
      const btn  = root.querySelector('.ms-btn');
      const panel= root.querySelector('.ms-panel');
      const all  = root.querySelector(`#${rootId}_all`);
      const list = root.querySelector(`#${rootId}_list`);
      const apply= root.querySelector(`#${rootId}_apply`);
      const clear= root.querySelector(`#${rootId}_clear`);
      let items = []; let selected = new Set();
      const updateBtn = ()=>{ if(selected.size===0) btn.querySelector('span').textContent=placeholder;
        else if (selected.size===items.length) btn.querySelector('span').textContent='Todos';
        else if (selected.size===1) btn.querySelector('span').textContent=[...selected][0];
        else btn.querySelector('span').textContent=`${selected.size} selecionadas`; };
      const render = ()=>{ list.innerHTML = items.map(v=>`<div class="ms-row"><input type="checkbox" id="${rootId}_${v}" value="${v}" ${selected.has(v)?'checked':''}><label for="${rootId}_${v}">${v}</label></div>`).join(''); all.checked = selected.size===items.length && items.length>0; updateBtn(); };
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); root.classList.toggle('open'); });
      document.addEventListener('click', ()=> root.classList.remove('open')); panel.addEventListener('click', (e)=> e.stopPropagation());
      all.addEventListener('change', ()=>{ selected = all.checked ? new Set(items) : new Set(); render(); });
      list.addEventListener('change', (e)=>{ if (e.target && e.target.type==='checkbox'){ const v=e.target.value; if (e.target.checked) selected.add(v); else selected.delete(v); all.checked = selected.size===items.length; updateBtn(); }});
      clear.addEventListener('click', ()=>{ selected.clear(); all.checked=false; render(); });
      apply.addEventListener('click', ()=>{ root.classList.remove('open'); refreshPareto(); });
      return { setItems(arr){ items=[...arr]; selected.clear(); render(); }, values(){ return [...selected]; }, setSelected(arr){ const set = new Set(arr||[]); selected = new Set(items.filter(v => set.has(v))); render(); } };
    }
    const msBases    = createMultiSelect('msBases','Todas as Bases');
    const msPrefixos = createMultiSelect('msPrefixos','Todas as Aeronaves');

    function chip(status){
      const S = String(status||'').toUpperCase();
      if (S==='STAND BY' || S==='DISPONIVEL') return '<span class="chip sb">DISPONÍVEL</span>';
      if (S==='MISSÃO' || S==='MISSAO') return '<span class="chip ms">EM MISSÃO</span>';
      if (S==='MNT' || S==='INDISPONIVEL') return '<span class="chip mt">INDISPONÍVEL</span>';
      return `<span class="chip">${status||'-'}</span>`;
    }

    // === Substitui a função renderListaGrouped antiga por esta (inclui data-prefixo) ===
   function renderListaGrouped(rows){
      const baseSel = $('#progBase').value || '';
      const norm = s => String(s||'').toLowerCase();

      const DISP = []; // Disponível
      const IND  = []; // Indisponível (MNT)

      for (const r of rows){
        if (baseSel && norm(r.Base)!==norm(baseSel)) continue;
        const st = String(r.Status||'').toUpperCase();

        const horas = getHoras(r.Prefixo);
        const horasChip = horas > 0
          ? `<span class="chip hr">${horas.toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})} h</span>`
          : '';

        // prefixo com atributo data-prefixo e classe clicável
        const card = `
          <div class="card" data-prefixo="${r.Prefixo||''}">
            <div class="title">
              <div class="prefixo" data-prefixo="${r.Prefixo||''}" title="Clique para alterar o status">${r.Prefixo||'-'}</div>
              <div style="display:flex;gap:8px;align-items:center">
                ${horasChip}
                ${chip(r.Status)}
              </div>
            </div>
            <div class="muted">${r.Base||'-'} • ${r.Data||'-'}</div>
            <div class="meta">
              <div><b>Missão:</b> ${r.Missao||'-'}</div>
              <div><b>CMTE:</b> ${r.Comandante||'-'}</div>
              <div><b>MEC:</b> ${r.Mecanico||'-'}</div>
              ${r.Motivo_Manutencao ? `<div><b>Motivo:</b> ${r.Motivo_Manutencao}</div>` : ``}
              ${r.Previsao ? `<div><b>Previsão:</b> ${r.Previsao}</div>` : ``}
            </div>
            ${r.Observacoes ? `<div class="muted" style="margin-top:8px">${r.Observacoes}</div>` : ``}
          </div>`;

        if (st==='MNT' || st==='INDISPONIVEL') IND.push(card);
        else           DISP.push(card);
      }

      $('#dispList').innerHTML = DISP.length ? DISP.join('') : `<div class="muted">—</div>`;
      $('#indList').innerHTML  = IND.length  ? IND.join('')  : `<div class="muted">—</div>`;

      $('#cntDISP').textContent = `(${DISP.length})`;
      $('#cntIND').textContent  = `(${IND.length})`;
    }

    /* Charts */
    function drawColumns(rows, isMonthly){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string', isMonthly ? 'Mês' : 'Data');
      dt.addColumn('number','Disponível');
      dt.addColumn('number','Indisponível');
      (isMonthly ? rows.map(r=>[String(r.Mes), +r['Disponível']||0, +r['Indisponível']||0])
                 : rows.map(r=>[String(r.Data), +r['Disponível']||0, +r['Indisponível']||0])
      ).forEach(r=>dt.addRow(r));
      const options = {
        legend:{ position:'bottom', textStyle:{ color:'#cbd5e1' } },
        backgroundColor:'transparent',
        hAxis:{ textStyle:{ color:'#94a3b8' } },
        vAxis:{ textStyle:{ color:'#94a3b8' }, gridlines:{ color:'#1f2937' } },
        chartArea:{ left:40, top:10, right:10, height:260 },
        height:360,
        isStacked:false,
        series:{ 0:{ color:'#22c55e' }, 1:{ color:'#ef4444' } }
      };
      new google.visualization.ColumnChart($('#chart_div')).draw(dt, options);
    }
    function drawPie(rows, date){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string','Status'); dt.addColumn('number','Qtde');
      rows.forEach(r=> dt.addRow([r.Status, Number(r.Qtde||0)]));
      $('#pie_date_hint').textContent = 'Dia: '+date;
      const options = {
        pieHole:0.55, legend:{position:'bottom', textStyle:{color:'#cbd5e1'}},
        backgroundColor:'transparent',
        chartArea:{ left:10, top:10, right:10, height:180 },
        slices:{ 0:{color:'#22c55e'}, 1:{color:'#3b82f6'}, 2:{color:'#ef4444'} }
      };
      new google.visualization.PieChart($('#pie_div')).draw(dt, options);
    }
    function drawPareto(rows){
      // rows: [{Motivo, Qtde}, ...]
      const dt = new google.visualization.DataTable();
      dt.addColumn('string','Motivo'); dt.addColumn('number','Qtde'); dt.addColumn({type:'string', role:'annotation'});
      rows.forEach(r=> dt.addRow([r.Motivo, Number(r.Qtde||0), String(r.Qtde||0)]));

      // color mapping by motive name (Programada=green, Discrepância=red, Administrativa=yellow)
      const colors = rows.map(r=>{
        const s = String(r.Motivo||'').toLowerCase();
        if (s.includes('program')) return '#22c55e';
        if (s.includes('discrep')) return '#ef4444';
        if (s.includes('administr') || s.includes('admin')) return '#f59e0b';
        // fallback
        return '#ef4444';
      });

      const options = {
        backgroundColor:'transparent', legend:'none',
        annotations:{ textStyle:{ color:'#e5e7eb', bold:true }},
        hAxis:{ textStyle:{ color:'#94a3b8' }, gridlines:{ color:'#1f2937' }, minValue:0 },
        vAxis:{ textStyle:{ color:'#94a3b8' } },
        colors: colors,
        chartArea:{ left:120, top:10, right:20, height:260 }, height:360
      };
      new google.visualization.BarChart($('#pareto_div')).draw(dt, options);
    }

    /* Dashboard loader */
    async function refreshAll(){
      const date    = $('#fData').value || '';
      const status  = $('#fStatus').value || '';
      const search  = $('#fBusca').value || '';
      const range   = $('#rangeSel').value || '30d';
      const base    = $('#baseChart').value || '';
      const prefixo = $('#prefChart').value || '';

      const progBaseVal = $('#progBase').value || '';
      const pieBaseSel  = $('#pieBase').value || '';
      const pieBase     = progBaseVal !== '' ? progBaseVal : pieBaseSel;

      const paretoBasesCSV    = msBases.values().join(',');
      const paretoPrefixosCSV = msPrefixos.values().join(',');

      // 1) HORAS DO MÊS -> preencher mapa para usar nos cards da programação
      HORAS_MAP = {};
      try{
        const h = await apiFetch({ fn:'horas', date });
        if (h && h.ok && h.data && Array.isArray(h.data.rows)){
          h.data.rows.forEach(r => {
            HORAS_MAP[String(r.Aeronave||'').trim()] = Number(r.Horas||0);
          });
        }
      }catch(e){ /* segue sem horas se falhar */ }

      // 2) RESTO DO DASH
      const qs = { fn:'dashboard', date, status, search, range, base, prefixos: prefixo, pieBase,
                   paretoBases: paretoBasesCSV, paretoPrefixos: paretoPrefixosCSV };
      const res = await apiFetch(qs);
      const data = res.data;

      // atualiza LOOKUPS globais (sevier se backend retornar missoes/comandantes/mecanicos)
      if (data && data.lookups){
        LOOKUPS.bases = data.lookups.bases || LOOKUPS.bases;
        LOOKUPS.prefixos = data.lookups.prefixos || LOOKUPS.prefixos;
        // optional arrays (may be undefined if backend not returning them)
        LOOKUPS.missoes = data.lookups.missoes || LOOKUPS.missoes || [];
        LOOKUPS.comandantes = data.lookups.comandantes || LOOKUPS.comandantes || [];
        LOOKUPS.mecanicos = data.lookups.mecanicos || LOOKUPS.mecanicos || [];
      }

      if ($('#baseChart').options.length<=1){
        const basesOpt   = '<option value="">Todas</option>' + (data.lookups.bases||[]).map(v=>`<option>${v}</option>`).join('');
        const prefOpt    = '<option value="">Todas</option>' + (data.lookups.prefixos||[]).map(v=>`<option>${v}</option>`).join('');
        $('#baseChart').innerHTML = basesOpt;
        $('#pieBase').innerHTML   = basesOpt;
        $('#progBase').innerHTML  = basesOpt;
        $('#prefChart').innerHTML = prefOpt;

        msBases.setItems(data.lookups.bases || []);
        msPrefixos.setItems(data.lookups.prefixos || []);
      }

      renderListaGrouped(data.list || []);
      // Total vindo do backend (deduplicado/filtrado). Fallback = soma do mapa.
      let totalHoras = 0;
      try{
        const h = await apiFetch({ fn:'horas', date });
        if (h && h.ok && h.data){
          HORAS_MAP = {};
          if (Array.isArray(h.data.rows)){
            h.data.rows.forEach(r => {
              HORAS_MAP[String(r.Aeronave||'').trim()] = Number(r.Horas||0);
            });
          }
          totalHoras = Number(h.data.total || 0);
          if (!totalHoras){
            totalHoras = Object.values(HORAS_MAP).reduce((acc,v)=>acc+(Number(v)||0),0);
          }
        }
      }catch(e){ /* mantém 0 em caso de erro */ }

      $('#kDisp').textContent  = data.kpis.disponiveis ?? '0';
      $('#kInd').textContent   = data.kpis.manutencao ?? '0';
      $('#kHoras').textContent = Number(totalHoras).toLocaleString('pt-BR',{
        minimumFractionDigits:1, maximumFractionDigits:1
      });

      google.charts.setOnLoadCallback(()=> {
        drawPie(data.pie || [], date);
        drawColumns(data.series || [], range==='12m');
        drawPareto(data.pareto || []);
      });
    }
    const refreshPareto = debounce(refreshAll, 150);

    /* ===== Funções para alterar status via API (setstatus) ===== */
    async function setStatusPrefixo(prefixo, status, extras={}){
      const params = {
        fn: 'setstatus',
        prefixo,
        status,
        date: extras.date || (document.getElementById('fData') && document.getElementById('fData').value) || '',
        missao: extras.missao || '',
        comandante: extras.comandante || '',
        mecanico: extras.mecanico || '',
        motivo: extras.motivo || '',
        obs: extras.obs || ''
      };
      const r = await apiFetch(params);
      if (!r || !r.ok) throw new Error((r && r.error) || 'Falha ao salvar');
      return r.data;
    }

    /* ===== Modal UI para editar status + seleção de Missão/CMTE/MEC ===== */
    function buildModalHtml(prefixo){
      // fallback arrays seguros
      const missoes = (LOOKUPS && LOOKUPS.missoes && LOOKUPS.missoes.length) ? LOOKUPS.missoes : [];
      const cmtes   = (LOOKUPS && LOOKUPS.comandantes && LOOKUPS.comandantes.length) ? LOOKUPS.comandantes : [];
      const mecs    = (LOOKUPS && LOOKUPS.mecanicos && LOOKUPS.mecanicos.length) ? LOOKUPS.mecanicos : [];

      // If lookup arrays are empty, still provide option to "Digitar"
      const missaoOptions = missoes.length ? missoes.map(m=>`<option value="${m}">${m}</option>`).join('') : '';
      const cmteOptions = cmtes.length ? cmtes.map(m=>`<option value="${m}">${m}</option>`).join('') : '';
      const mecOptions = mecs.length ? mecs.map(m=>`<option value="${m}">${m}</option>`).join('') : '';

      return `
        <div class="modal-backdrop" id="modalBackdrop">
          <div class="modal" role="dialog" aria-modal="true">
            <h3>Editar status — ${prefixo}</h3>

            <div class="row">
              <div class="small">Escolha 1 = Disponível ou 2 = Indisponível</div>
              <div style="display:flex;gap:8px;margin-top:6px">
                <button id="optDisponivel" class="btn primary" type="button">1 — Disponível</button>
                <button id="optIndisponivel" class="btn" type="button">2 — Indisponível</button>
              </div>
            </div>

            <div class="row">
              <label>Motivo de Indisponibilidade (se 2 selecionado)
                <select id="selMotivo" class="input">
                  <option value="">— Selecione —</option>
                  <option value="Programada">Programada</option>
                  <option value="Discrepância">Discrepância</option>
                  <option value="Administrativa">Administrativa</option>
                </select>
                <div id="motivoHelp" class="small" style="margin-top:6px">Obrigatório quando Indisponível.</div>
              </label>
            </div>

            <div class="row">
              <label>Missão
                <select id="selMissao" class="input">
                  <option value="">— Selecione —</option>
                  ${missaoOptions}
                  <option value="__OUTRO__">— Digitar outro —</option>
                </select>
                <input id="inpMissao" class="input" style="margin-top:6px;display:none" placeholder="Digite a missão">
              </label>

              <label>Comandante
                <select id="selCmte" class="input">
                  <option value="">— Selecione —</option>
                  ${cmteOptions}
                  <option value="__OUTRO__">— Digitar outro —</option>
                </select>
                <input id="inpCmte" class="input" style="margin-top:6px;display:none" placeholder="Digite o comandante">
              </label>

              <label>Mecânico
                <select id="selMec" class="input">
                  <option value="">— Selecione —</option>
                  ${mecOptions}
                  <option value="__OUTRO__">— Digitar outro —</option>
                </select>
                <input id="inpMec" class="input" style="margin-top:6px;display:none" placeholder="Digite o mecânico">
              </label>
            </div>

            <div class="row">
              <label>Observações
                <input id="inpObs" class="input" placeholder="Observações (opcional)">
              </label>
            </div>

            <div class="actions">
              <button id="btnCancel" class="btn" type="button">Cancelar</button>
              <button id="btnSave" class="btn primary" type="button">Salvar</button>
            </div>
          </div>
        </div>
      `;
    }

    async function showEditModal(prefixo){
      // remove modal anterior se existir
      const prev = document.getElementById('modalBackdrop');
      if (prev && prev.parentNode) prev.parentNode.removeChild(prev);

      // cria modal
      const container = document.createElement('div');
      container.innerHTML = buildModalHtml(prefixo);
      document.body.appendChild(container.firstElementChild);

      // elementos
      const bp = document.getElementById('modalBackdrop');
      const selMissao = document.getElementById('selMissao');
      const selCmte   = document.getElementById('selCmte');
      const selMec    = document.getElementById('selMec');
      const inpMissao = document.getElementById('inpMissao');
      const inpCmte   = document.getElementById('inpCmte');
      const inpMec    = document.getElementById('inpMec');
      const inpObs    = document.getElementById('inpObs');
      const selMotivo = document.getElementById('selMotivo');
      const motivoHelp = document.getElementById('motivoHelp');

      // toggle "Outro (digitar)"
      selMissao && selMissao.addEventListener('change', ()=> { inpMissao.style.display = selMissao.value==='__OUTRO__' ? 'block' : 'none'; });
      selCmte   && selCmte.addEventListener('change', ()=> { inpCmte.style.display   = selCmte.value==='__OUTRO__' ? 'block' : 'none'; });
      selMec    && selMec.addEventListener('change', ()=> { inpMec.style.display    = selMec.value==='__OUTRO__' ? 'block' : 'none'; });

      // Buttons
      document.getElementById('btnCancel').addEventListener('click', ()=> { const b = document.getElementById('modalBackdrop'); if (b && b.parentNode) b.parentNode.removeChild(b); });
      const btnSave = document.getElementById('btnSave');

      btnSave.addEventListener('click', async ()=>{
        // determinar status
        const sDisp = document.getElementById('optDisponivel').classList.contains('primary');
        const sInd  = document.getElementById('optIndisponivel').classList.contains('primary');
        const status = sInd ? 'INDISPONIVEL' : 'DISPONIVEL';

        // quando indisponível, motivo obrigatório
        const motivoVal = (selMotivo && selMotivo.value) ? selMotivo.value : '';
        if (sInd && !motivoVal){
          alert('Selecione o motivo de indisponibilidade (Programada / Discrepância / Administrativa).');
          return;
        }

        // Missao / Cmte / Mec
        const missao = (selMissao && selMissao.value === '__OUTRO__') ? (inpMissao.value.trim()||'') : (selMissao ? selMissao.value : '');
        const comandante = (selCmte && selCmte.value === '__OUTRO__') ? (inpCmte.value.trim()||'') : (selCmte ? selCmte.value : '');
        const mecanico = (selMec && selMec.value === '__OUTRO__') ? (inpMec.value.trim()||'') : (selMec ? selMec.value : '');
        const obs = inpObs ? inpObs.value.trim() : '';

        // visual feedback
        btnSave.classList.add('btnLoading');
        btnSave.textContent = 'Salvando...';

        try{
          await setStatusPrefixo(prefixo, status, { missao, comandante, mecanico, motivo: motivoVal, obs, date: (document.getElementById('fData')&&document.getElementById('fData').value) || '' });
          // fecha modal e atualiza
          const b = document.getElementById('modalBackdrop'); if (b && b.parentNode) b.parentNode.removeChild(b);
          await refreshAll();
        }catch(err){
          console.error(err);
          alert('Erro ao salvar: ' + (err.message||err));
        }finally{
          // restore label (if modal still open)
          if (document.getElementById('btnSave')){
            document.getElementById('btnSave').classList.remove('btnLoading');
            document.getElementById('btnSave').textContent = 'Salvar';
          }
        }
      });

      // Quick toggle behaviour
      const btnDisp = document.getElementById('optDisponivel');
      const btnInd  = document.getElementById('optIndisponivel');
      const setActive = (which)=>{
        if (which==='disp'){ btnDisp.classList.add('primary'); btnInd.classList.remove('primary'); selMotivo.value=''; motivoHelp.style.display='none'; }
        else { btnInd.classList.add('primary'); btnDisp.classList.remove('primary'); motivoHelp.style.display='block'; }
      };
      btnDisp.addEventListener('click', ()=> setActive('disp'));
      btnInd.addEventListener('click', ()=> setActive('ind'));
      setActive('disp');

      // fechar clicando fora
      bp.addEventListener('click', (ev)=>{ if (ev.target === bp){ if (bp && bp.parentNode) bp.parentNode.removeChild(bp); } });
    }

    // Delegação de clique: garante que prefixos dinâmicos abram modal
    document.addEventListener('click', (ev) => {
      const el = ev.target.closest('.prefixo[data-prefixo]');
      if (!el) return;
      const prefixo = el.getAttribute('data-prefixo') || el.textContent.trim();
      if (!prefixo) return;
      showEditModal(prefixo);
    });

    /* Eventos */
    $('#btnFiltrar').addEventListener('click', refreshAll);
    $('#btnHoje').addEventListener('click', ()=>{ $('#fData').value = new Date().toISOString().slice(0,10); refreshAll(); });
    $('#btnRefresh').addEventListener('click', refreshAll);
    $('#btnLogout').addEventListener('click', logout);
    $('#btnLogin').addEventListener('click', login);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && $('#loginBox').style.display!=='none') login(); });

    $('#baseChart').addEventListener('change', ()=>{ refreshAll(); });
    $('#prefChart').addEventListener('change', ()=>{ refreshAll(); });
    $('#rangeSel').addEventListener('change', refreshAll);
    $('#pieBase').addEventListener('change', refreshAll);
    $('#progBase').addEventListener('change', ()=>{ $('#pieBase').value = $('#progBase').value || ''; refreshAll(); });

    $('#paretoRangeSel').addEventListener('change', refreshPareto);
    $('#fBusca').addEventListener('input', debounce(refreshAll, 400));
    $('#fStatus').addEventListener('change', refreshAll);

    (async function init(){
      // começa mostrando o login; se token válido, troca para dash
      showLogin();
      try{
        const ok = await checkMe();
        if (ok){ showDash(); await refreshAll(); }
      }catch(e){
        console.error(e);
        const el = document.getElementById('lgErr');
        if (el) el.textContent = 'Erro ao conectar à API. Confira a URL e a implantação.';
      }
    })();

    /* ====== Baixar PDF ====== */
    async function downloadPDF(){
      try{
        const node = document.getElementById('exportRoot') || document.getElementById('exportArea');
        if (!node) { alert('Não encontrei a área a exportar (exportRoot/exportArea).'); return; }

        if (!window.html2canvas) { alert('html2canvas não carregado.'); return; }
        if (!window.jspdf || !window.jspdf.jsPDF) { alert('jsPDF não carregado.'); return; }

        await new Promise(r=>requestAnimationFrame(r));

        const scale = Math.max(2, (window.devicePixelRatio || 1)) * 1.25;
        const canvas = await html2canvas(node, {
          backgroundColor: getComputedStyle(document.body).backgroundColor || '#0b1320',
          scale,
          useCORS: true,
          windowWidth: Math.max(document.documentElement.clientWidth, node.scrollWidth)
        });

        const imgData = canvas.toDataURL('image/png');
        const w = canvas.width, h = canvas.height;

        const margin = 36;
        const pdfW = w + margin * 2;
        const pdfH = h + margin * 2;

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: pdfW >= pdfH ? 'landscape' : 'portrait',
          unit: 'pt',
          format: [pdfW, pdfH]
        });

        pdf.addImage(imgData, 'PNG', margin, margin, w, h, undefined, 'FAST');
        pdf.save(`Dashboard_Frota_${new Date().toISOString().slice(0,10)}.pdf`);
      }catch(err){
        console.error('Erro ao gerar PDF:', err);
        alert('Não foi possível gerar o PDF. Veja o console (F12) para detalhes.');
      }
    }

    // liga o botão (uma vez só)
    const btnDl = document.getElementById('btnDownload');
    if (btnDl) btnDl.onclick = downloadPDF;
  </script>

</body>
</html>
