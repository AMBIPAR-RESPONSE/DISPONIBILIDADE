<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Disponibilidade da Frota</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL@1" rel="stylesheet" />
  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1320; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937;
      --brand:#22c55e; --brand-2:#3b82f6; --danger:#ef4444; --chip:#0f172a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}

    .topbar{
      position:sticky;top:0;z-index:10;background:rgba(11,19,32,.9);
      backdrop-filter: blur(8px);border-bottom:1px solid var(--border);
    }
    .topbar .row{display:flex;align-items:center;gap:16px;min-height:64px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px rgba(34,197,94,.25)}
    .spacer{flex:1}
    .btn{height:38px;padding:0 14px;border-radius:10px;border:1px solid var(--border);display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    .btn.primary{background:var(--brand);border:none;color:#052e16;font-weight:700}
    .btn.ghost{background:transparent;color:var(--muted)}

    .filters{display:flex;flex-wrap:wrap;gap:10px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:14px;margin-top:14px}
    .input, select, button{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
    .input::placeholder{color:#64748b}
    .row{display:flex;gap:12px;align-items:center}
    label{display:flex;flex-direction:column;gap:6px;color:#cbd5e1;font-size:12px}

    .kpis{display:grid;gap:14px;margin-top:16px}
    @media(min-width:900px){.kpis{grid-template-columns:repeat(3,1fr)}}
    .kpi{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .kpi .icon{width:44px;height:44px;border-radius:12px;display:grid;place-items:center}
    .kpi h3{margin:0;font-size:13px;color:var(--muted);font-weight:700;letter-spacing:.3px;text-transform:uppercase}
    .kpi .val{font-size:28px;font-weight:800;margin-top:4px}
    .i-green{background:rgba(34,197,94,.12);color:#34d399}
    .i-blue {background:rgba(59,130,246,.10);color:#60a5fa}
    .i-red  {background:rgba(239,68,68,.10);color:#f87171}

    .section{display:flex;align-items:center;justify-content:space-between;margin:24px 0 10px}
    .section h2{margin:0;font-size:18px}

    .grid-3{display:grid;gap:14px}
    @media(min-width:900px){.grid-3{grid-template-columns:repeat(3,1fr)}}
    .col{display:flex;flex-direction:column;gap:14px}
    .colTitle{display:flex;align-items:center;justify-content:space-between;color:#cbd5e1;margin-bottom:4px;font-weight:700;letter-spacing:.2px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .prefixo{font-weight:800;font-size:18px}
    .chip{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;background:var(--chip);border:1px solid var(--border)}
    .chip.sb{color:#34d399}.chip.ms{color:#60a5fa}.chip.mt{color:#f87171}
    .muted{color:var(--muted);font-size:12px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:#cbd5e1;font-size:13px;margin-top:8px}

    #chart_div{height:360px}
    #pie_div{height:260px}
    #pareto_div{height:360px}
    .foot{margin:28px 0;color:#64748b;font-size:12px;text-align:center}

    /* Divider */
    .divider{
      position:relative;margin:26px 0 10px;border-top:6px solid var(--border);
    }
    .divider > span{
      position:absolute;top:-16px;left:18px;padding:0 10px;
      background:var(--bg);color:#dbe3ef;font-weight:800;font-size:18px;
      letter-spacing:.2px;
    }

    /* MultiSelect (checkbox) */
    .ms{position:relative;min-width:220px}
    .ms-btn{display:flex;align-items:center;justify-content:space-between;gap:10px;min-width:220px;height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text);cursor:pointer}
    .ms-panel{position:absolute;top:44px;left:0;background:var(--card);border:1px solid var(--border);border-radius:12px;min-width:280px;max-height:280px;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;z-index:50}
    .ms.open .ms-panel{display:block}
    .ms-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04)}
    .ms-row:last-child{border-bottom:0}
    .ms-row input{width:16px;height:16px}
    .ms-title{font-size:12px;color:#9aa4b2;padding:8px 12px 0}
    .ms-footer{display:flex;gap:8px;justify-content:flex-end;padding:10px}
    .ms-footer button{height:34px;padding:0 12px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap row">
      <div class="brand"><span class="dot"></span> Disponibilidade da Frota</div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnRefresh" title="Atualizar">
        <span class="material-symbols-rounded">refresh</span> Atualizar
      </button>
      <button class="btn primary" id="btnDownload" title="Baixar PDF">
        <span class="material-symbols-rounded">download</span> Download
      </button>
    </div>
  </div>

  <div class="wrap">
    <!-- Filtros globais -->
    <div class="filters">
      <div class="row" style="flex:1;flex-wrap:wrap">
        <label>Data <input class="input" type="date" id="fData"></label>
        <label>Status
          <select id="fStatus">
            <option value="">Todos</option>
            <option value="STAND BY">STAND BY</option>
            <option value="MISS√ÉO">MISS√ÉO</option>
            <option value="MNT">MNT</option>
          </select>
        </label>
        <label>Buscar <input class="input" id="fBusca" placeholder="Prefixo, CMTE, Mec√¢nico..."></label>
      </div>
      <div class="row">
        <button class="btn ghost" id="btnHoje"><span class="material-symbols-rounded">calendar_month</span>&nbsp;Hoje</button>
        <button class="btn primary" id="btnFiltrar"><span class="material-symbols-rounded">tune</span>&nbsp;Aplicar</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><div class="icon i-green">‚úì</div><div><h3>Dispon√≠veis</h3><div class="val" id="kDisp">‚Äî</div></div></div>
      <div class="kpi"><div class="icon i-blue">‚úà</div><div><h3>Em Miss√£o</h3><div class="val" id="kMissao">‚Äî</div></div></div>
      <div class="kpi"><div class="icon i-red">üõ†</div><div><h3>Em Manuten√ß√£o</h3><div class="val" id="kMnt">‚Äî</div></div></div>
    </div>

    <!-- ===== √ÅREA DE EXPORTA√á√ÉO (Programa√ß√£o + Pizza) ===== -->
    <div id="exportArea">
      <!-- Programa√ß√£o agrupada -->
      <div class="section">
        <h2>Programa√ß√£o</h2>
        <div class="row">
          <label>Base
            <select id="progBase" style="min-width:180px">
              <option value="">Todas</option>
            </select>
          </label>
        </div>
      </div>
      <div id="lista" class="grid-3"></div>

      <!-- Pizza -->
      <div class="section">
        <h2>Status do dia</h2>
        <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap">
          <div class="muted" id="pie_date_hint"></div>
          <div style="flex:1"></div>
          <label>Base
            <select id="pieBase" style="min-width:180px">
              <option value="">Todas</option>
            </select>
          </label>
        </div>
      </div>
      <div id="pie_div"></div>
    </div>
    <!-- ===== FIM exportArea ===== -->

    <!-- Divisor com t√≠tulo -->
    <div class="divider"><span>Indicadores de Disponibilidade</span></div>

    <!-- Gr√°fico barras -->
    <div class="section">
      <h2>Dispon√≠veis x Indispon√≠veis</h2>
      <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap">
        <label>Base
          <select id="baseChart" style="min-width:180px">
            <option value="">Todas</option>
          </select>
        </label>
        <label>Aeronave
          <select id="prefChart" style="min-width:160px">
            <option value="">Todas</option>
          </select>
        </label>
        <div style="flex:1"></div>
        <label>Per√≠odo
          <select id="rangeSel">
            <option value="15d">15 dias</option>
            <option value="30d" selected>30 dias</option>
            <option value="60d">60 dias</option>
            <option value="90d">90 dias</option>
            <option value="180d">180 dias</option>
            <option value="12m">12 meses</option>
          </select>
        </label>
      </div>
    </div>
    <div id="chart_div"></div>

    <!-- Pareto -->
    <div class="section">
      <h2>Pareto ‚Ä¢ Motivos de Manuten√ß√£o</h2>
      <div class="row" style="gap:14px; align-items:center; flex-wrap:wrap">
        <label>Per√≠odo
          <select id="paretoRangeSel">
            <option value="15d">15 dias</option>
            <option value="30d" selected>30 dias</option>
            <option value="60d">60 dias</option>
            <option value="90d">90 dias</option>
            <option value="180d">180 dias</option>
            <option value="12m">12 meses</option>
          </select>
        </label>

        <!-- MultiSelect Bases -->
        <div class="ms" id="msBases">
          <div class="ms-btn"><span>Todas as Bases</span><span class="material-symbols-rounded" style="font-size:18px">expand_more</span></div>
          <div class="ms-panel">
            <div class="ms-title">Bases</div>
            <div class="ms-row"><input type="checkbox" id="msBases_all"><label for="msBases_all">Selecionar todas</label></div>
            <div id="msBases_list"></div>
            <div class="ms-footer">
              <button class="btn ghost" type="button" id="msBases_clear">Limpar</button>
              <button class="btn primary" type="button" id="msBases_apply">Aplicar</button>
            </div>
          </div>
        </div>

        <!-- MultiSelect Prefixos -->
        <div class="ms" id="msPrefixos">
          <div class="ms-btn"><span>Todas as Aeronaves</span><span class="material-symbols-rounded" style="font-size:18px">expand_more</span></div>
          <div class="ms-panel">
            <div class="ms-title">Aeronaves</div>
            <div class="ms-row"><input type="checkbox" id="msPrefixos_all"><label for="msPrefixos_all">Selecionar todas</label></div>
            <div id="msPrefixos_list"></div>
            <div class="ms-footer">
              <button class="btn ghost" type="button" id="msPrefixos_clear">Limpar</button>
              <button class="btn primary" type="button" id="msPrefixos_apply">Aplicar</button>
            </div>
          </div>
        </div>

      </div>
    </div>
    <div id="pareto_div"></div>

    <div class="foot">Atualiza a partir da sua planilha (Apps Script como API) ‚Ä¢ Visual p√∫blico</div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzuPkCWigr-hm6qTn6xe3OFndDwKHhfypAbXmlj5H1VkU15Fzrq5nnJN42qsnQcz73D/exec';
    google.charts.load('current', {'packages':['corechart']});
    const $ = s => document.querySelector(s);
    const debounce = (fn,ms=350)=>{ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);}};

    /************** MultiSelect helper **************/
    function createMultiSelect(rootId, placeholder){
      const root = document.getElementById(rootId);
      const btn  = root.querySelector('.ms-btn');
      const panel= root.querySelector('.ms-panel');
      const all  = root.querySelector(`#${rootId}_all`);
      const list = root.querySelector(`#${rootId}_list`);
      const apply= root.querySelector(`#${rootId}_apply`);
      const clear= root.querySelector(`#${rootId}_clear`);

      let items = []; // valores simples
      let selected = new Set();

      const updateBtn = ()=>{
        if (selected.size===0) btn.querySelector('span').textContent = placeholder;
        else if (selected.size===items.length) btn.querySelector('span').textContent = 'Todos';
        else if (selected.size===1) btn.querySelector('span').textContent = [...selected][0];
        else btn.querySelector('span').textContent = `${selected.size} selecionadas`;
      };

      const render = ()=>{
        list.innerHTML = items.map(v=>`
          <div class="ms-row">
            <input type="checkbox" id="${rootId}_${v}" value="${v}" ${selected.has(v)?'checked':''}>
            <label for="${rootId}_${v}">${v}</label>
          </div>`).join('');
        all.checked = selected.size===items.length && items.length>0;
        updateBtn();
      };

      btn.addEventListener('click', (e)=>{ e.stopPropagation(); root.classList.toggle('open'); });
      document.addEventListener('click', ()=> root.classList.remove('open'));
      panel.addEventListener('click', (e)=> e.stopPropagation());

      all.addEventListener('change', ()=>{
        if (all.checked){ selected = new Set(items); }
        else { selected.clear(); }
        render();
      });

      list.addEventListener('change', (e)=>{
        if (e.target && e.target.type==='checkbox'){
          const v=e.target.value;
          if (e.target.checked) selected.add(v); else selected.delete(v);
          all.checked = selected.size===items.length;
          updateBtn();
        }
      });

      clear.addEventListener('click', ()=>{ selected.clear(); all.checked=false; render(); });
      apply.addEventListener('click', ()=>{ root.classList.remove('open'); refreshPareto(); });

      return {
        setItems(arr){ items=[...arr]; selected.clear(); render(); },
        values(){ return [...selected]; },
        setSelectedAll(){ selected=new Set(items); render(); },
        setSelected(arr){
          const set = new Set(arr||[]);
          selected = new Set(items.filter(v => set.has(v)));
          render();
        }
      };
    }

    const msBases    = createMultiSelect('msBases','Todas as Bases');
    const msPrefixos = createMultiSelect('msPrefixos','Todas as Aeronaves');

    /************** UI helpers **************/
    function chip(status){
      const S = String(status||'').toUpperCase();
      if (S==='STAND BY') return '<span class="chip sb">STAND BY</span>';
      if (S==='MISS√ÉO' || S==='MISSAO') return '<span class="chip ms">MISS√ÉO</span>';
      if (S==='MNT') return '<span class="chip mt">MNT</span>';
      return `<span class="chip">${status||'-'}</span>`;
    }
    function renderListaGrouped(rows){
      const baseSel = $('#progBase').value || '';
      const norm = s => String(s||'').toLowerCase();
      const SB=[], MS=[], MNT=[];
      for(const r of rows){
        if (baseSel && norm(r.Base)!==norm(baseSel)) continue;
        const st = String(r.Status||'').toUpperCase();
        const card = `
          <div class="card">
            <div class="title">
              <div class="prefixo">${r.Prefixo||'-'}</div>
              ${chip(r.Status)}
            </div>
            <div class="muted">${r.Base||'-'} ‚Ä¢ ${r.Data||'-'}</div>
            <div class="meta">
              <div><b>Miss√£o:</b> ${r.Missao||'-'}</div>
              <div><b>CMTE:</b> ${r.Comandante||'-'}</div>
              <div><b>MEC:</b> ${r.Mecanico||'-'}</div>
              ${r.Motivo_Manutencao ? `<div><b>Manuten√ß√£o:</b> ${r.Motivo_Manutencao}</div>` : ``}
            </div>
            ${r.Observacoes ? `<div class="muted" style="margin-top:8px">${r.Observacoes}</div>` : ``}
          </div>`;
        if (st==='STAND BY') SB.push(card);
        else if (st==='MNT') MNT.push(card);
        else MS.push(card);
      }
      const col = (title, arr) => `
        <div class="col">
          <div class="colTitle">${title} <span class="muted">(${arr.length})</span></div>
          ${arr.length ? arr.join('') : `<div class="muted">‚Äî</div>`}
        </div>`;
      $('#lista').innerHTML = col('STAND BY', SB) + col('EM MISS√ÉO', MS) + col('EM MANUTEN√á√ÉO', MNT);
    }

    /* Charts */
    function drawColumns(rows, isMonthly){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string', isMonthly ? 'M√™s' : 'Data');
      dt.addColumn('number','Dispon√≠vel');
      dt.addColumn('number','Indispon√≠vel');
      (isMonthly ? rows.map(r=>[String(r.Mes), +r['Dispon√≠vel']||0, +r['Indispon√≠vel']||0])
                 : rows.map(r=>[String(r.Data), +r['Dispon√≠vel']||0, +r['Indispon√≠vel']||0])
      ).forEach(r=>dt.addRow(r));
      const options = {
        legend:{ position:'bottom', textStyle:{ color:'#cbd5e1' } },
        backgroundColor:'transparent',
        hAxis:{ textStyle:{ color:'#94a3b8' } },
        vAxis:{ textStyle:{ color:'#94a3b8' }, gridlines:{ color:'#1f2937' } },
        chartArea:{ left:40, top:10, right:10, height:260 },
        height:360,
        isStacked:false,
        series:{ 0:{ color:'#22c55e' }, 1:{ color:'#ef4444' } }
      };
      new google.visualization.ColumnChart($('#chart_div')).draw(dt, options);
    }
    function drawPie(rows, date){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string','Status'); dt.addColumn('number','Qtde');
      rows.forEach(r=> dt.addRow([r.Status, Number(r.Qtde||0)]));
      $('#pie_date_hint').textContent = 'Dia: '+date;
      const options = {
        pieHole:0.55, legend:{position:'bottom', textStyle:{color:'#cbd5e1'}},
        backgroundColor:'transparent',
        chartArea:{ left:10, top:10, right:10, height:180 },
        slices:{ 0:{color:'#22c55e'}, 1:{color:'#3b82f6'}, 2:{color:'#ef4444'} }
      };
      new google.visualization.PieChart($('#pie_div')).draw(dt, options);
    }
    function drawPareto(rows){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string','Motivo');
      dt.addColumn('number','Qtde');
      dt.addColumn({type:'string', role:'annotation'});
      rows.forEach(r=> dt.addRow([r.Motivo, Number(r.Qtde||0), String(r.Qtde||0)]));
      const options = {
        backgroundColor:'transparent',
        legend:'none',
        annotations:{ textStyle:{ color:'#e5e7eb', bold:true }},
        hAxis:{ textStyle:{ color:'#94a3b8' }, gridlines:{ color:'#1f2937' }, minValue:0 },
        vAxis:{ textStyle:{ color:'#94a3b8' } },
        colors:['#ef4444'],
        chartArea:{ left:120, top:10, right:20, height:260 },
        height:360
      };
      new google.visualization.BarChart($('#pareto_div')).draw(dt, options);
    }

    /* Dashboard loader */
    async function refreshAll(){
      const date    = $('#fData').value || '';
      const status  = $('#fStatus').value || '';
      const search  = $('#fBusca').value || '';
      const range   = $('#rangeSel').value || '30d';
      const base    = $('#baseChart').value || '';
      const prefixo = $('#prefChart').value || '';

      // Pizza: prioridade √† Base da Programa√ß√£o; se vazia, usa o seletor da pr√≥pria pizza
      const progBaseVal = $('#progBase').value || '';
      const pieBaseSel  = $('#pieBase').value || '';
      const pieBase     = progBaseVal !== '' ? progBaseVal : pieBaseSel;

      const paretoBasesCSV    = msBases.values().join(',');
      const paretoPrefixosCSV = msPrefixos.values().join(',');

      const qs = {
        fn:'dashboard', date, status, search, range,
        base, prefixos: prefixo, pieBase,
        paretoBases: paretoBasesCSV, paretoPrefixos: paretoPrefixosCSV
      };
      const url = API_URL + '?' + new URLSearchParams(qs).toString();
      const res = await fetch(url).then(r=>r.json());
      const data = res.data;

      // Lookups 1¬™ vez
      if ($('#baseChart').options.length<=1){
        const basesOpt   = '<option value="">Todas</option>' + data.lookups.bases.map(v=>`<option>${v}</option>`).join('');
        const prefOpt    = '<option value="">Todas</option>' + data.lookups.prefixos.map(v=>`<option>${v}</option>`).join('');
        $('#baseChart').innerHTML = basesOpt;
        $('#pieBase').innerHTML   = basesOpt;
        $('#progBase').innerHTML  = basesOpt;
        $('#prefChart').innerHTML = prefOpt;

        msBases.setItems(data.lookups.bases);
        msPrefixos.setItems(data.lookups.prefixos);
      }

      renderListaGrouped(data.list);
      $('#kDisp').textContent = data.kpis.disponiveis ?? '0';
      $('#kMissao').textContent = data.kpis.missao ?? '0';
      $('#kMnt').textContent   = data.kpis.manutencao ?? '0';

      google.charts.setOnLoadCallback(()=> {
        drawPie(data.pie, date);
        drawColumns(data.series, range==='12m');
        drawPareto(data.pareto);
      });
    }
    const refreshPareto = debounce(refreshAll, 150);

    /* Eventos */
    $('#btnFiltrar').addEventListener('click', refreshAll);
    $('#btnHoje').addEventListener('click', ()=>{ $('#fData').value = new Date().toISOString().slice(0,10); refreshAll(); });
    $('#btnRefresh').addEventListener('click', refreshAll);

    // Sincroniza√ß√£o: filtros do gr√°fico de barras -> filtros do Pareto
    $('#baseChart').addEventListener('change', ()=>{
      const v = $('#baseChart').value;
      msBases.setSelected(v ? [v] : []);
      refreshAll();
    });
    $('#prefChart').addEventListener('change', ()=>{
      const v = $('#prefChart').value;
      msPrefixos.setSelected(v ? [v] : []);
      refreshAll();
    });

    $('#rangeSel').addEventListener('change', refreshAll);
    $('#pieBase').addEventListener('change', refreshAll);

    // Quando a base da programa√ß√£o muda, sincroniza visualmente a pizza e recarrega
    $('#progBase').addEventListener('change', ()=>{
      $('#pieBase').value = $('#progBase').value || '';
      refreshAll();
    });

    $('#paretoRangeSel').addEventListener('change', refreshPareto);
    $('#fBusca').addEventListener('input', debounce(refreshAll, 400));
    $('#fStatus').addEventListener('change', refreshAll);

    (async function init(){
      $('#fData').value = new Date().toISOString().slice(0,10);
      await refreshAll();
    })();

    /* ===== Download PDF (uma √∫nica p√°gina at√© Programa√ß√£o + Pizza) ===== */
    document.getElementById('btnDownload').addEventListener('click', async () => {
      const area = document.getElementById('exportArea');
      const canvas = await html2canvas(area, {
        backgroundColor: '#0b1320',
        scale: 2,
        useCORS: true
      });
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;

      const a4 = { w: 210, h: 297 }; // mm
      const areaRatio = canvas.width / canvas.height;
      const a4PortraitRatio = a4.w / a4.h;
      const orientation = areaRatio > a4PortraitRatio ? 'l' : 'p';

      const pdf = new jsPDF(orientation, 'mm', 'a4');
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 8;

      // Ajuste para caber inteiro numa √∫nica p√°gina
      let imgW = pageW - margin * 2;
      let imgH = (canvas.height * imgW) / canvas.width;
      if (imgH > pageH - margin * 2) {
        imgH = pageH - margin * 2;
        imgW = (canvas.width * imgH) / canvas.height;
      }

      const x = (pageW - imgW) / 2;
      const y = (pageH - imgH) / 2;

      pdf.addImage(imgData, 'PNG', x, y, imgW, imgH, '', 'FAST');
      pdf.save(`Dashboard_Frota_${new Date().toISOString().slice(0,10)}.pdf`);
    });
  </script>
</body>
</html>
