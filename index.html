<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Disponibilidade da Frota</title>

  <!-- Fontes & √çcones -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL@1" rel="stylesheet" />
  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root{
      --bg:#0b1320; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937;
      --brand:#22c55e; --brand-2:#3b82f6; --danger:#ef4444; --chip:#0f172a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}

    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,19,32,.9);backdrop-filter: blur(8px);border-bottom:1px solid var(--border);}
    .topbar .row{display:flex;align-items:center;gap:16px;min-height:64px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px rgba(34,197,94,.25)}
    .spacer{flex:1}

    .filters{display:flex;flex-wrap:wrap;gap:10px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:14px;margin-top:14px}
    .input, select, button{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
    .input::placeholder{color:#64748b}
    button.primary{background:var(--brand);border:none;color:#052e16;font-weight:700}
    button.ghost{background:transparent;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}

    .kpis{display:grid;gap:14px;margin-top:16px}
    @media(min-width:900px){.kpis{grid-template-columns:repeat(3,1fr)}}
    .kpi{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .kpi .icon{width:44px;height:44px;border-radius:12px;display:grid;place-items:center}
    .kpi h3{margin:0;font-size:13px;color:var(--muted);font-weight:700;letter-spacing:.3px;text-transform:uppercase}
    .kpi .val{font-size:28px;font-weight:800;margin-top:4px}
    .i-green{background:rgba(34,197,94,.12);color:#34d399}
    .i-blue {background:rgba(59,130,246,.10);color:#60a5fa}
    .i-red  {background:rgba(239,68,68,.10);color:#f87171}

    .section{display:flex;align-items:center;justify-content:space-between;margin:24px 0 10px}
    .section h2{margin:0;font-size:18px}

    .grid{display:grid;gap:14px}
    @media(min-width:1000px){
      .prog-grid{grid-template-columns:repeat(3,1fr)}
    }
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .prefixo{font-weight:800;font-size:18px}
    .chip{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;background:var(--chip);border:1px solid var(--border)}
    .chip.sb{color:#34d399}
    .chip.ms{color:#60a5fa}
    .chip.mt{color:#f87171}
    .muted{color:var(--muted);font-size:12px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:#cbd5e1;font-size:13px;margin-top:8px}

    /* charts */
    #pie_div{height:300px}
    #chart_div{height:340px}
    #pareto_div{height:360px}

    .foot{margin:28px 0;color:#64748b;font-size:12px;text-align:center}

    /* pequenas badges de contagem por coluna */
    .col-head{display:flex;align-items:center;gap:10px;margin:6px 0 10px}
    .pill{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0b1220;color:#9ca3af}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap row">
      <div class="brand"><span class="dot"></span> Disponibilidade da Frota</div>
      <div class="spacer"></div>
      <a class="muted" href="#" id="btnRefresh" title="Atualizar">
        <span class="material-symbols-rounded">refresh</span>
      </a>
    </div>
  </div>

  <div class="wrap">
    <!-- Filtros (Programa√ß√£o + KPIs) -->
    <div class="filters">
      <div class="row" style="flex:1;flex-wrap:wrap">
        <label>Data <input class="input" type="date" id="fData"></label>

        <label>Status
          <select id="fStatus">
            <option value="">Todos</option>
            <option value="STAND BY">STAND BY</option>
            <option value="MISS√ÉO">MISS√ÉO</option>
            <option value="MNT">MNT</option>
          </select>
        </label>

        <label>Base
          <!-- ESTA BASE CONTROLA A PIZZA -->
          <select id="progBaseSel">
            <option value="">Todas</option>
          </select>
        </label>

        <label>Buscar <input class="input" id="fBusca" placeholder="Prefixo, CMTE, Mec√¢nico..."></label>
      </div>
      <div class="row">
        <button class="ghost" id="btnHoje"><span class="material-symbols-rounded">calendar_month</span>&nbsp;Hoje</button>
        <button class="primary" id="btnFiltrar"><span class="material-symbols-rounded">tune</span>&nbsp;Aplicar</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><div class="icon i-green">‚úì</div><div><h3>Dispon√≠veis</h3><div class="val" id="kDisp">‚Äî</div></div></div>
      <div class="kpi"><div class="icon i-blue">‚úà</div><div><h3>Em Miss√£o</h3><div class="val" id="kMissao">‚Äî</div></div></div>
      <div class="kpi"><div class="icon i-red">üõ†</div><div><h3>Em Manuten√ß√£o</h3><div class="val" id="kMnt">‚Äî</div></div></div>
    </div>

    <!-- ===================== PIZZA (AGORA PRIMEIRO) ===================== -->
    <div class="section">
      <h2>Status do dia</h2>
      <div class="row" style="gap:16px">
        <div class="muted" id="pie_date_hint"></div>
        <div class="spacer"></div>
        <div class="muted">Base da Programa√ß√£o controla este gr√°fico</div>
      </div>
    </div>
    <div id="pie_div"></div>

    <!-- ===================== BARRAS (DEPOIS) ===================== -->
    <div class="section">
      <h2>Dispon√≠veis x Indispon√≠veis</h2>
      <div class="row">
        <label>Base
          <select id="barBaseSel"></select>
        </label>
        <label>Aeronave
          <select id="barPrefSel"></select>
        </label>
        <label>Per√≠odo
          <select id="rangeSel">
            <option value="15d">15 dias</option>
            <option value="30d" selected>30 dias</option>
            <option value="60d">60 dias</option>
            <option value="90d">90 dias</option>
            <option value="180d">180 dias</option>
            <option value="12m">12 meses</option>
          </select>
        </label>
      </div>
    </div>
    <div id="chart_div"></div>

    <!-- ===================== PROGRAMA√á√ÉO (TR√äS COLUNAS) ===================== -->
    <div class="section" style="margin-top:28px">
      <h2>Programa√ß√£o</h2>
      <div class="row">
        <label class="muted">Base
          <select id="progBaseDup" disabled>
            <option>Todas</option>
          </select>
        </label>
      </div>
    </div>

    <div class="grid prog-grid" id="progColumns">
      <div>
        <div class="col-head"><strong>STAND BY</strong><span class="pill" id="countSB">0</span></div>
        <div id="colSB"></div>
      </div>
      <div>
        <div class="col-head"><strong>EM MISS√ÉO</strong><span class="pill" id="countMS">0</span></div>
        <div id="colMS"></div>
      </div>
      <div>
        <div class="col-head"><strong>EM MANUTEN√á√ÉO</strong><span class="pill" id="countMT">0</span></div>
        <div id="colMT"></div>
      </div>
    </div>

    <!-- ===================== PARETO ===================== -->
    <div class="section">
      <h2>Pareto ‚Ä¢ Motivos de Manuten√ß√£o</h2>
      <div class="row">
        <label>Per√≠odo
          <select id="paretoRangeSel">
            <option value="15d">15 dias</option>
            <option value="30d" selected>30 dias</option>
            <option value="60d">60 dias</option>
            <option value="90d">90 dias</option>
            <option value="180d">180 dias</option>
            <option value="12m">12 meses</option>
          </select>
        </label>
        <label>Bases
          <select id="paretoBasesSel" multiple size="1"></select>
        </label>
        <label>Aeronaves
          <select id="paretoPrefSel" multiple size="1"></select>
        </label>
      </div>
    </div>
    <div id="pareto_div"></div>

    <div class="foot">Atualiza a partir da sua planilha (Apps Script como API) ‚Ä¢ Visual p√∫blico</div>
  </div>

  <script>
    // ======= CONFIGURE AQUI =======
    const API_URL = 'https://script.google.com/macros/library/d/1EycseqnF8M0d2Idibd81Vo4iprJbSkmYAHt7ualx7sNoJ1KTmtkczU-H/13';
    // ==============================

    google.charts.load('current', {'packages':['corechart']});
    const $ = s => document.querySelector(s);

    // API helper
    async function api(fn, params = {}) {
      const qs = new URLSearchParams({ fn, ...params }).toString();
      const res = await fetch(`${API_URL}?${qs}`, { method: 'GET' });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'Erro na API');
      return json.data;
    }

    // ====== RENDER LISTA / PROGRAMA√á√ÉO ======
    function chip(status){
      const S = String(status||'').toUpperCase();
      if (S==='STAND BY') return '<span class="chip sb">STAND BY</span>';
      if (S==='MISS√ÉO' || S==='MISSAO') return '<span class="chip ms">MISS√ÉO</span>';
      if (S==='MNT') return '<span class="chip mt">MNT</span>';
      return `<span class="chip">${status||'-'}</span>`;
    }

    function renderProgramacao(rows){
      // separa por status e filtra pela base de programa√ß√£o
      const baseProg = ($('#progBaseSel') ? $('#progBaseSel').value : '') || '';
      const norm = v => String(v||'').toLowerCase();
      const f = baseProg ? rows.filter(r => norm(r.Base)===norm(baseProg)) : rows.slice();

      const sb = f.filter(r => String(r.Status).toUpperCase()==='STAND BY');
      const ms = f.filter(r => ['MISS√ÉO','MISSAO'].includes(String(r.Status).toUpperCase()));
      const mt = f.filter(r => String(r.Status).toUpperCase()==='MNT');

      $('#countSB').textContent = sb.length;
      $('#countMS').textContent = ms.length;
      $('#countMT').textContent = mt.length;

      const card = r => `
        <div class="card">
          <div class="title">
            <div class="prefixo">${r.Prefixo||'-'}</div>
            ${chip(r.Status)}
          </div>
          <div class="muted">${r.Base||'-'} ‚Ä¢ ${r.Data||'-'}</div>
          <div class="meta">
            <div><b>Miss√£o:</b> ${r.Missao||'-'}</div>
            <div><b>CMTE:</b> ${r.Comandante||'-'}</div>
            <div><b>MEC:</b> ${r.Mecanico||'-'}</div>
            ${r.Motivo_Manutencao ? `<div><b>Manuten√ß√£o:</b> ${r.Motivo_Manutencao}</div>` : ``}
          </div>
          ${r.Observacoes ? `<div class="muted" style="margin-top:8px">${r.Observacoes}</div>` : ``}
        </div>
      `;

      $('#colSB').innerHTML = sb.map(card).join('') || '<div class="muted">‚Äî</div>';
      $('#colMS').innerHTML = ms.map(card).join('') || '<div class="muted">‚Äî</div>';
      $('#colMT').innerHTML = mt.map(card).join('') || '<div class="muted">‚Äî</div>';
    }

    function setKpis(k){
      $('#kDisp').textContent = k.disponiveis ?? '0';
      $('#kMissao').textContent = k.missao ?? '0';
      $('#kMnt').textContent   = k.manutencao ?? '0';
    }

    async function carregarListaEKpis(){
      const date = $('#fData').value || '';
      const status = $('#fStatus').value || '';
      const search = $('#fBusca').value || '';

      const data = await api('list', { date, status, search });
      renderProgramacao(data);

      const k = await api('kpis', { date });
      setKpis(k);
    }

    // ====== CHARTS ======
    // PIZZA (usa Base da Programa√ß√£o)
    function drawPie(rows, date){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string','Status'); dt.addColumn('number','Qtde');
      rows.forEach(r=> dt.addRow([r.Status, Number(r.Qtde||0)]));
      $('#pie_date_hint').textContent = 'Dia: '+date;
      const options = {
        pieHole:0.55, legend:{position:'bottom', textStyle:{color:'#cbd5e1'}},
        backgroundColor:'transparent',
        chartArea:{ left:10, top:10, right:10, height:220 },
        slices:{
          0:{color:'#22c55e'}, // Dispon√≠vel
          1:{color:'#3b82f6'}, // Miss√£o
          2:{color:'#ef4444'}  // Manuten√ß√£o
        }
      };
      new google.visualization.PieChart($('#pie_div')).draw(dt, options);
    }
    async function carregarPizza(){
      const date = $('#fData').value || new Date().toISOString().slice(0,10);
      const baseProg = ($('#progBaseSel') ? $('#progBaseSel').value : '') || '';
      const rows = await api('pie', { date, base: baseProg });
      google.charts.setOnLoadCallback(()=> drawPie(rows, date));
    }

    // BARRAS
    function drawBars(rows, isMonthly){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string', isMonthly ? 'M√™s' : 'Data');
      dt.addColumn('number','Dispon√≠vel');
      dt.addColumn('number','Indispon√≠vel');

      (isMonthly ? rows.map(r=>[String(r.Mes), +r['Dispon√≠vel']||0, +r['Indispon√≠vel']||0])
                 : rows.map(r=>[String(r.Data), +r['Dispon√≠vel']||0, +r['Indispon√≠vel']||0])
      ).forEach(row=>dt.addRow(row));

      const options = {
        backgroundColor:'transparent',
        isStacked:true,
        legend:{ position:'bottom', textStyle:{ color:'#cbd5e1' } },
        hAxis:{ textStyle:{ color:'#94a3b8' } },
        vAxis:{ textStyle:{ color:'#94a3b8' }, gridlines:{ color:'#1f2937' } },
        chartArea:{ left:40, top:10, right:10, height:250 },
        height:340,
        series:{ 0:{ color:'#22c55e' }, 1:{ color:'#ef4444' } }
      };
      new google.visualization.ColumnChart($('#chart_div')).draw(dt, options);
    }
    async function carregarGrafico(){
      const range = $('#rangeSel').value || '30d';
      const base = $('#barBaseSel').value || '';
      const pref = $('#barPrefSel').value || '';
      const rows = await api('series', { range, base, prefixos: pref });
      const isMonthly = (range === '12m');
      google.charts.setOnLoadCallback(()=> drawBars(rows, isMonthly));
    }

    // PARETO
    function drawPareto(rows){
      const dt = new google.visualization.DataTable();
      dt.addColumn('string','Motivo'); dt.addColumn('number','Qtde'); dt.addColumn({type:'string', role:'annotation'});
      rows.forEach(r=> dt.addRow([r.Motivo, Number(r.Qtde||0), String(r.Qtde||0)]));
      const options = {
        backgroundColor:'transparent', legend:'none',
        annotations:{ textStyle:{ color:'#e5e7eb', bold:true }},
        hAxis:{ textStyle:{ color:'#94a3b8' }, gridlines:{ color:'#1f2937' }, minValue:0 },
        vAxis:{ textStyle:{ color:'#94a3b8' } },
        colors:['#ef4444'],
        chartArea:{ left:120, top:10, right:20, height:260 },
        height:360
      };
      new google.visualization.BarChart($('#pareto_div')).draw(dt, options);
    }
    async function carregarPareto(){
      const range = $('#paretoRangeSel').value || '30d';
      const bases = Array.from($('#paretoBasesSel').selectedOptions).map(o=>o.value).join(',');
      const prefs = Array.from($('#paretoPrefSel').selectedOptions).map(o=>o.value).join(',');
      const rows = await api('pareto', { range, bases, prefixos: prefs });
      google.charts.setOnLoadCallback(()=> drawPareto(rows));
    }

    // ====== LOOKUPS / COMBOS ======
    async function carregarLookups(){
      const lk = await api('lookups');
      // programacao base
      const pSel = $('#progBaseSel');
      pSel.innerHTML = '<option value="">Todas</option>' + lk.bases.map(b=>`<option>${b}</option>`).join('');

      // barras (base / aeronave)
      $('#barBaseSel').innerHTML = '<option value="">Todas</option>' + lk.bases.map(b=>`<option>${b}</option>`).join('');
      $('#barPrefSel').innerHTML = '<option value="">Todas</option>' + lk.prefixos.map(p=>`<option>${p}</option>`).join('');

      // pareto m√∫ltiplo
      $('#paretoBasesSel').innerHTML = lk.bases.map(b=>`<option>${b}</option>`).join('');
      $('#paretoPrefSel').innerHTML  = lk.prefixos.map(p=>`<option>${p}</option>`).join('');
    }

    // ====== EVENTOS UI ======
    $('#btnFiltrar').addEventListener('click', ()=>{
      carregarListaEKpis();
      carregarPizza();     // pizza usa base da programa√ß√£o
    });
    $('#btnHoje').addEventListener('click', ()=>{
      const d = new Date(); $('#fData').value = d.toISOString().slice(0,10);
      carregarListaEKpis();
      carregarPizza();
    });
    $('#btnRefresh').addEventListener('click', ()=>{
      carregarListaEKpis(); carregarPizza(); carregarGrafico(); carregarPareto();
    });

    // quando mudar a base da programa√ß√£o, recalcula lista e pizza
    if ($('#progBaseSel')) {
      $('#progBaseSel').addEventListener('change', ()=>{
        carregarListaEKpis();
        carregarPizza();
      });
    }

    $('#rangeSel').addEventListener('change', carregarGrafico);
    $('#barBaseSel').addEventListener('change', carregarGrafico);
    $('#barPrefSel').addEventListener('change', carregarGrafico);
    $('#paretoRangeSel').addEventListener('change', carregarPareto);
    $('#paretoBasesSel').addEventListener('change', carregarPareto);
    $('#paretoPrefSel').addEventListener('change', carregarPareto);

    // ====== INIT ======
    (async function init(){
      $('#fData').value = new Date().toISOString().slice(0,10);
      await carregarLookups();
      await carregarListaEKpis();
      await carregarPizza();     // pizza primeiro na tela
      await carregarGrafico();   // barras abaixo
      await carregarPareto();
    })();
  </script>
</body>
</html>
